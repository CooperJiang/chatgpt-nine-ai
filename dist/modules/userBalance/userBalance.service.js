'use strict';const _0x46f431=_0x1e1b;(function(_0x152c73,_0x25f14f){const _0x394d36=_0x1e1b,_0x5a80a1=_0x152c73();while(!![]){try{const _0x4b079e=parseInt(_0x394d36(0xe9))/0x1*(-parseInt(_0x394d36(0xd5))/0x2)+parseInt(_0x394d36(0x100))/0x3*(parseInt(_0x394d36(0x10b))/0x4)+-parseInt(_0x394d36(0x10f))/0x5*(parseInt(_0x394d36(0xd3))/0x6)+-parseInt(_0x394d36(0xf8))/0x7*(-parseInt(_0x394d36(0xdf))/0x8)+parseInt(_0x394d36(0xde))/0x9+parseInt(_0x394d36(0x120))/0xa*(parseInt(_0x394d36(0x11c))/0xb)+parseInt(_0x394d36(0x10e))/0xc;if(_0x4b079e===_0x25f14f)break;else _0x5a80a1['push'](_0x5a80a1['shift']());}catch(_0x181a67){_0x5a80a1['push'](_0x5a80a1['shift']());}}}(_0xdff2,0xbd6aa));var __decorate=this&&this[_0x46f431(0xf6)]||function(_0xcd820b,_0x4931ea,_0x2a9ccb,_0x51f24f){const _0x51753e=_0x46f431;var _0x588acb=arguments[_0x51753e(0x113)],_0x10bf65=_0x588acb<0x3?_0x4931ea:_0x51f24f===null?_0x51f24f=Object[_0x51753e(0xd9)](_0x4931ea,_0x2a9ccb):_0x51f24f,_0x1c7b51;if(typeof Reflect===_0x51753e(0x108)&&typeof Reflect['decorate']===_0x51753e(0xf9))_0x10bf65=Reflect[_0x51753e(0x121)](_0xcd820b,_0x4931ea,_0x2a9ccb,_0x51f24f);else{for(var _0x25ae83=_0xcd820b[_0x51753e(0x113)]-0x1;_0x25ae83>=0x0;_0x25ae83--)if(_0x1c7b51=_0xcd820b[_0x25ae83])_0x10bf65=(_0x588acb<0x3?_0x1c7b51(_0x10bf65):_0x588acb>0x3?_0x1c7b51(_0x4931ea,_0x2a9ccb,_0x10bf65):_0x1c7b51(_0x4931ea,_0x2a9ccb))||_0x10bf65;}return _0x588acb>0x3&&_0x10bf65&&Object[_0x51753e(0xf0)](_0x4931ea,_0x2a9ccb,_0x10bf65),_0x10bf65;},__metadata=this&&this['__metadata']||function(_0x375681,_0x5b87e9){const _0x3d257a=_0x46f431;if(typeof Reflect===_0x3d257a(0x108)&&typeof Reflect['metadata']==='function')return Reflect[_0x3d257a(0xcf)](_0x375681,_0x5b87e9);},__param=this&&this[_0x46f431(0xf7)]||function(_0x4fcbc7,_0x4ac032){return function(_0x52a61e,_0x1d0507){_0x4ac032(_0x52a61e,_0x1d0507,_0x4fcbc7);};};Object['defineProperty'](exports,_0x46f431(0xd2),{'value':!![]}),exports[_0x46f431(0xe0)]=void 0x0;const typeorm_1=require(_0x46f431(0xfd)),balance_entity_1=require(_0x46f431(0xe2)),common_1=require(_0x46f431(0xdd)),typeorm_2=require(_0x46f431(0xf1)),balance_constant_1=require('../../common/constants/balance.constant'),accountLog_entity_1=require(_0x46f431(0x105)),utils_1=require(_0x46f431(0xcc)),config_entity_1=require(_0x46f431(0xd6));function _0xdff2(){const _0x15a6fe=['saveRecordRechargeLog','>\x20购买卡密充值\x20！','save','registerSendBalanceNum','缺失当前用户账户记录！','paintCount','defineProperty','typeorm','usePaints','validateBalance','deductFromBalance','design:paramtypes','__decorate','__param','7BqBxhw','function','HttpStatus','update','addBalanceToUser','@nestjs/typeorm','configEntity','queryUserBalanceByIds','1736631noZFrZ','RechargeType','Repository','DeductionUseKey','reduce','./accountLog.entity','registerSendDrawNum','INVITE_GIFT','object','accountLogEntity','vxNumber','4IxFXnF','addBalanceToNewUser','error:\x20','2164140NxyvhU','70115JaJAPT','configKey','balanceEntity','balance','length','getRechargeLog','findAndCount','configVal','HttpException','user','注册赠送失败,请联系管理员！','find','firstRegisterSendStatus','1087108lemUiW','firstRregisterSendChatNum','useTokens','AccountLogEntity','80vGCqlD','decorate','Injectable','REFER_GIFT','../../common/utils','充值失败','firstRregisterSendDrawNum','metadata','queryUserBalance','InjectRepository','__esModule','474agczbR','useChats','42820buzFUG','../globalConfig/config.entity','DESC','registerSendStatus','getOwnPropertyDescriptor','usesLeft','findOne','registerSendChatNum','@nestjs/common','2584566iwXDqP','10992536udaPZe','UserBalanceService','firstRegisterSendRank','./balance.entity','affected','firstRregisterSendBalanceNum','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','BAD_REQUEST','isInteger','消费余额失败！','62uLMzWk'];_0xdff2=function(){return _0x15a6fe;};return _0xdff2();}let UserBalanceService=class UserBalanceService{constructor(_0x2233ae,_0x21cfd4,_0x43fa40){const _0x2d4d1f=_0x46f431;this[_0x2d4d1f(0x111)]=_0x2233ae,this[_0x2d4d1f(0x109)]=_0x21cfd4,this['configEntity']=_0x43fa40;}async[_0x46f431(0x10c)](_0x14785a,_0x237138){const _0x4ee56b=_0x46f431;try{const _0x1b99ef=await this[_0x4ee56b(0xfe)][_0x4ee56b(0x11a)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x4ee56b(0xd8),_0x4ee56b(0xdc),_0x4ee56b(0x106),_0x4ee56b(0xed),_0x4ee56b(0x11b),_0x4ee56b(0xe1),_0x4ee56b(0x11d),_0x4ee56b(0xce),_0x4ee56b(0xe4)])}}),_0x4e65d2=_0x1b99ef[_0x4ee56b(0x104)]((_0x2fe559,_0x2b8d3d)=>{const _0x429d46=_0x4ee56b,_0x4fd92c=Number(_0x2b8d3d[_0x429d46(0x116)]),_0x2dcdff=Number[_0x429d46(0xe7)](_0x4fd92c)&&_0x4fd92c>0x0?_0x4fd92c:0x0;return _0x2fe559[_0x2b8d3d[_0x429d46(0x110)]]=_0x2dcdff,_0x2fe559;},{});let _0x77ab5f=0x0,_0x392761=0x0,_0x13aae2=0x0;_0x4e65d2['registerSendStatus']===0x1&&(_0x77ab5f=_0x77ab5f+_0x4e65d2[_0x4ee56b(0xdc)],_0x392761=_0x392761+_0x4e65d2['registerSendDrawNum'],_0x13aae2=_0x13aae2+_0x4e65d2['registerSendBalanceNum']),_0x4e65d2[_0x4ee56b(0xd8)]===0x1&&_0x4e65d2['firstRegisterSendStatus']===0x1&&_0x14785a<=_0x4e65d2[_0x4ee56b(0xe1)]&&(_0x77ab5f=_0x77ab5f+_0x4e65d2['firstRregisterSendChatNum'],_0x392761=_0x392761+_0x4e65d2[_0x4ee56b(0xce)],_0x13aae2=_0x13aae2+_0x4e65d2[_0x4ee56b(0xe4)]),await this[_0x4ee56b(0xea)]({'userId':_0x14785a,'rechargeType':balance_constant_1[_0x4ee56b(0x101)]['REG_GIFT'],'usesLeft':_0x77ab5f,'paintCount':_0x392761,'balance':_0x13aae2}),_0x237138&&(_0x77ab5f=_0x77ab5f+0xa,_0x392761=_0x392761+0x1,_0x13aae2=_0x13aae2+0x0,await this[_0x4ee56b(0xea)]({'userId':_0x14785a,'rechargeType':balance_constant_1[_0x4ee56b(0x101)][_0x4ee56b(0x107)],'usesLeft':0xa,'paintCount':0x1,'balance':_0x13aae2}),await this[_0x4ee56b(0xfc)](_0x237138,{'usesLeft':0x1e,'paintCount':0x3,'balance':0x0}),await this['saveRecordRechargeLog']({'userId':_0x237138,'rechargeType':balance_constant_1[_0x4ee56b(0x101)][_0x4ee56b(0xcb)],'usesLeft':0x1e,'paintCount':0x3,'balance':0x0})),await this[_0x4ee56b(0x111)][_0x4ee56b(0xec)]({'userId':_0x14785a,'balance':_0x13aae2,'usesLeft':_0x77ab5f,'paintCount':_0x392761,'useTokens':0x0});}catch(_0x511c6c){console['log'](_0x4ee56b(0x10d),_0x511c6c);throw new common_1[(_0x4ee56b(0x117))](_0x4ee56b(0x119),common_1[_0x4ee56b(0xfa)][_0x4ee56b(0xe6)]);}}async[_0x46f431(0xf3)](_0x212db0,_0xb42120,_0x6df4d0){const _0x5a0642=_0x46f431,_0x39aecf=await this[_0x5a0642(0x111)][_0x5a0642(0xdb)]({'where':{'userId':_0x212db0}});if(!_0x39aecf)throw new common_1[(_0x5a0642(0x117))](_0x5a0642(0xee),common_1[_0x5a0642(0xfa)][_0x5a0642(0xe6)]);const _0x57be3d=await this[_0x5a0642(0xfe)]['findOne']({'where':{'configKey':_0x5a0642(0x10a)}}),_0x1678ee=_0x57be3d?_0x57be3d[_0x5a0642(0x116)]:'---';if(_0x39aecf[_0xb42120]<_0x6df4d0)throw new common_1[(_0x5a0642(0x117))](_0x5a0642(0xe5)+_0x1678ee+_0x5a0642(0xeb),common_1[_0x5a0642(0xfa)]['BAD_REQUEST']);}async[_0x46f431(0xf4)](_0x296dc3,_0x5bdaf7,_0x31ef7a,_0x1ac8e7=0x0){const _0x2345d3=_0x46f431,_0x50dd9d=await this[_0x2345d3(0x111)][_0x2345d3(0xdb)]({'where':{'userId':_0x296dc3}});if(!_0x50dd9d)throw new common_1[(_0x2345d3(0x117))](_0x2345d3(0xee),common_1[_0x2345d3(0xfa)][_0x2345d3(0xe6)]);const {balance:_0x404561,usesLeft:_0xdb1bd5,paintCount:_0x210c8e,useTokens:_0x3f3e98,usePaints:_0x2bd72c,useChats:_0x49f05c}=_0x50dd9d,_0x1c7458=balance_constant_1[_0x2345d3(0x103)][_0x5bdaf7],_0x2a2a87={[_0x5bdaf7]:_0x50dd9d[_0x5bdaf7]-_0x31ef7a,[_0x1c7458]:_0x50dd9d[_0x1c7458]+_0x1ac8e7};_0x1c7458===_0x2345d3(0x11e)&&(_0x2a2a87[_0x2345d3(0xd4)]=_0x49f05c+0x1);const _0x2d25e2=await this[_0x2345d3(0x111)][_0x2345d3(0xfb)]({'userId':_0x296dc3},_0x2a2a87);if(_0x2d25e2[_0x2345d3(0xe3)]===0x0)throw new common_1[(_0x2345d3(0x117))](_0x2345d3(0xe8),common_1[_0x2345d3(0xfa)][_0x2345d3(0xe6)]);}async[_0x46f431(0xd0)](_0x40695f){const _0x27d846=_0x46f431;return await this[_0x27d846(0x111)]['findOne']({'where':{'userId':_0x40695f},'select':[_0x27d846(0x112),'usesLeft',_0x27d846(0xef),_0x27d846(0x11e),'useChats',_0x27d846(0xf2)]});}async['saveRecordRechargeLog']({userId:_0x142883,rechargeType:_0x289b9b,usesLeft:_0x3da1ba,paintCount:_0x2d4903,balance:_0x4d862a,extent:extent=''}){const _0x1a8835=_0x46f431;if(!_0x142883)throw new common_1['HttpException']('缺失用户ID,记录充值日志异常',common_1[_0x1a8835(0xfa)][_0x1a8835(0xe6)]);const _0x1d2d78=(0x0,utils_1['createRandomUid'])();return await this['accountLogEntity'][_0x1a8835(0xec)]({'userId':_0x142883,'rechargeType':_0x289b9b,'usesLeft':_0x3da1ba,'paintCount':_0x2d4903,'balance':_0x4d862a,'extent':extent,'uid':_0x1d2d78});}async[_0x46f431(0xfc)](_0x3dc908,_0x2b3e3c={'usesLeft':0x0,'paintCount':0x0,'balance':0x0}){const _0x408c36=_0x46f431,_0x16a8c0=await this['balanceEntity'][_0x408c36(0xdb)]({'where':{'userId':_0x3dc908}});if(!_0x16a8c0)throw new common_1[(_0x408c36(0x117))](_0x408c36(0xee),common_1[_0x408c36(0xfa)][_0x408c36(0xe6)]);const {usesLeft:_0x4f480b,paintCount:_0x3bacf8,balance:_0x2adb18}=_0x16a8c0,_0x1ba4d0=await this[_0x408c36(0x111)]['update']({'userId':_0x3dc908},{'usesLeft':_0x4f480b+_0x2b3e3c[_0x408c36(0xda)],'paintCount':_0x3bacf8+_0x2b3e3c[_0x408c36(0xef)],'balance':_0x2adb18+_0x2b3e3c[_0x408c36(0x112)]});if(_0x1ba4d0['affected']===0x0)throw new common_1[(_0x408c36(0x117))](_0x3dc908+_0x408c36(0xcd),common_1[_0x408c36(0xfa)][_0x408c36(0xe6)]);}async[_0x46f431(0x114)](_0x1c6135,_0x9518f1){const _0x7cef7f=_0x46f431,{page:page=0x1,pageSize:pageSize=0x14}=_0x9518f1,{id:_0x221e98}=_0x1c6135[_0x7cef7f(0x118)],[_0x3d97e7,_0x9c4043]=await this[_0x7cef7f(0x109)][_0x7cef7f(0x115)]({'where':{'userId':_0x221e98},'order':{'id':_0x7cef7f(0xd7)},'skip':(page-0x1)*pageSize,'take':pageSize});return{'rows':_0x3d97e7,'count':_0x9c4043};}async[_0x46f431(0xff)](_0x38f865){const _0x2c50e6=_0x46f431;return await this['balanceEntity'][_0x2c50e6(0x11a)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x38f865)}});}};function _0x1e1b(_0x597014,_0x4c29a5){const _0xdff2cc=_0xdff2();return _0x1e1b=function(_0x1e1b42,_0xe2ba2f){_0x1e1b42=_0x1e1b42-0xca;let _0x319471=_0xdff2cc[_0x1e1b42];return _0x319471;},_0x1e1b(_0x597014,_0x4c29a5);}UserBalanceService=__decorate([(0x0,common_1[_0x46f431(0xca)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(balance_entity_1['BalanceEntity'])),__param(0x1,(0x0,typeorm_1[_0x46f431(0xd1)])(accountLog_entity_1[_0x46f431(0x11f)])),__param(0x2,(0x0,typeorm_1[_0x46f431(0xd1)])(config_entity_1['ConfigEntity'])),__metadata(_0x46f431(0xf5),[typeorm_2['Repository'],typeorm_2[_0x46f431(0x102)],typeorm_2[_0x46f431(0x102)]])],UserBalanceService),exports['UserBalanceService']=UserBalanceService;