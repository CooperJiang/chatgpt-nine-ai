'use strict';const _0x5da06b=_0xdd66;function _0xdd66(_0x3f3928,_0x43f03e){const _0x1f4d3b=_0x1f4d();return _0xdd66=function(_0xdd6620,_0x1f3015){_0xdd6620=_0xdd6620-0x1d7;let _0x56cda0=_0x1f4d3b[_0xdd6620];return _0x56cda0;},_0xdd66(_0x3f3928,_0x43f03e);}(function(_0x1ac58c,_0x332358){const _0x34fba2=_0xdd66,_0x4d36c5=_0x1ac58c();while(!![]){try{const _0x2a2be0=parseInt(_0x34fba2(0x1ea))/0x1*(-parseInt(_0x34fba2(0x1d7))/0x2)+-parseInt(_0x34fba2(0x1e4))/0x3*(parseInt(_0x34fba2(0x20f))/0x4)+-parseInt(_0x34fba2(0x1dd))/0x5*(-parseInt(_0x34fba2(0x1f3))/0x6)+-parseInt(_0x34fba2(0x1f8))/0x7*(parseInt(_0x34fba2(0x1ed))/0x8)+-parseInt(_0x34fba2(0x1e9))/0x9+parseInt(_0x34fba2(0x1e0))/0xa+-parseInt(_0x34fba2(0x202))/0xb*(-parseInt(_0x34fba2(0x1db))/0xc);if(_0x2a2be0===_0x332358)break;else _0x4d36c5['push'](_0x4d36c5['shift']());}catch(_0x249ca9){_0x4d36c5['push'](_0x4d36c5['shift']());}}}(_0x1f4d,0x56363));function _0x1f4d(){const _0x2fb23d=['获取buffer成功','test','==================>\x20图片上传到cos完成!','getBufferFromUrl','42368fyKiGr','uploadFileFromUrl','52314vEmlxS','object','../globalConfig/globalConfig.service','cosSecretKey','672OQpKMv','cos','175190YycgEm','获取图片资源失败、请重新试试吧！','stream-to-buffer','6930300sNeEDc','proxyMj:\x20','function','BAD_REQUEST','186tfJjns','STANDARD','defineProperty','cosRegion','replace','3270564ALxtXx','9TWEYSu','get','getOwnPropertyDescriptor','19696uiBPVk','design:paramtypes','.png','HttpStatus','globalConfigService','buffer:\x20','66NuzQTG','data','stream','cosSecretId','default','714RLKlGV','length','UploadService','@nestjs/common','GlobalConfigService','__esModule','mjtest.png','cosBucket','Location','https://$2','153472peadMl','__metadata','__decorate','createRandomUid','error:\x20','log','metadata','HttpException','getConfigs'];_0x1f4d=function(){return _0x2fb23d;};return _0x1f4d();}var __decorate=this&&this[_0x5da06b(0x204)]||function(_0x38b41f,_0x1b110f,_0x5c5c,_0x3b89ab){const _0x20466f=_0x5da06b;var _0x1d1d8f=arguments[_0x20466f(0x1f9)],_0x46f2b7=_0x1d1d8f<0x3?_0x1b110f:_0x3b89ab===null?_0x3b89ab=Object[_0x20466f(0x1ec)](_0x1b110f,_0x5c5c):_0x3b89ab,_0x1e71b5;if(typeof Reflect==='object'&&typeof Reflect['decorate']==='function')_0x46f2b7=Reflect['decorate'](_0x38b41f,_0x1b110f,_0x5c5c,_0x3b89ab);else{for(var _0x1e0c13=_0x38b41f[_0x20466f(0x1f9)]-0x1;_0x1e0c13>=0x0;_0x1e0c13--)if(_0x1e71b5=_0x38b41f[_0x1e0c13])_0x46f2b7=(_0x1d1d8f<0x3?_0x1e71b5(_0x46f2b7):_0x1d1d8f>0x3?_0x1e71b5(_0x1b110f,_0x5c5c,_0x46f2b7):_0x1e71b5(_0x1b110f,_0x5c5c))||_0x46f2b7;}return _0x1d1d8f>0x3&&_0x46f2b7&&Object[_0x20466f(0x1e6)](_0x1b110f,_0x5c5c,_0x46f2b7),_0x46f2b7;},__metadata=this&&this[_0x5da06b(0x203)]||function(_0x3dda12,_0x236732){const _0x5454b1=_0x5da06b;if(typeof Reflect===_0x5454b1(0x1d8)&&typeof Reflect['metadata']===_0x5454b1(0x1e2))return Reflect[_0x5454b1(0x208)](_0x3dda12,_0x236732);};Object[_0x5da06b(0x1e6)](exports,_0x5da06b(0x1fd),{'value':!![]}),exports[_0x5da06b(0x1fa)]=void 0x0;const common_1=require(_0x5da06b(0x1fb)),COS=require('cos-nodejs-sdk-v5'),axios_1=require('axios'),streamToBuffer=require(_0x5da06b(0x1df)),utils_1=require('../../common/utils'),globalConfig_service_1=require(_0x5da06b(0x1d9));let UploadService=class UploadService{constructor(_0xd00f30){const _0x280923=_0x5da06b;this[_0x280923(0x1f1)]=_0xd00f30;}async['onModuleInit'](){}async['uploadFile']({filename:_0x43dc8b,buffer:_0x307b75,dir:dir='ai'}){const _0x3d2a3e=_0x5da06b,{cosSecretId:_0x5c49af,cosSecretKey:_0x271f39}=await this['globalConfigService'][_0x3d2a3e(0x20a)]([_0x3d2a3e(0x1f6),_0x3d2a3e(0x1da)]);this[_0x3d2a3e(0x1dc)]=new COS({'SecretId':_0x5c49af,'SecretKey':_0x271f39,'FileParallelLimit':0xa});const {cosBucket:_0x4a0ab9,cosRegion:_0x225e30}=await this[_0x3d2a3e(0x1f1)]['getConfigs']([_0x3d2a3e(0x1ff),_0x3d2a3e(0x1e7)]);try{return new Promise((_0x4f6867,_0xe1f0c3)=>{const _0x5d926a=_0x3d2a3e;this[_0x5d926a(0x1dc)]['putObject']({'Bucket':_0x4a0ab9,'Region':_0x225e30,'Key':dir+'/'+(_0x43dc8b||(0x0,utils_1[_0x5d926a(0x205)])()+_0x5d926a(0x1ef)),'StorageClass':'STANDARD','Body':_0x307b75},function(_0x4e24cf,_0x4d0b6b){const _0x20c216=_0x5d926a;if(_0x4e24cf)return _0xe1f0c3(_0x4e24cf);return _0x4f6867(_0x4d0b6b[_0x20c216(0x200)][_0x20c216(0x1e8)](/^(http:\/\/|https:\/\/|\/\/|)(.*)/,'https://$2'));});});}catch(_0x3977fd){throw new common_1[(_0x3d2a3e(0x209))]('上传图片失败',common_1['HttpStatus'][_0x3d2a3e(0x1e3)]);}}async[_0x5da06b(0x210)]({filename:_0x58c0d3,url:_0x1377d9,dir:dir='mj'}){const _0x126556=_0x5da06b,{cosBucket:_0x3cb412,cosRegion:_0x38dc65,cosSecretId:_0x6ff1c6,cosSecretKey:_0x49ffee}=await this['globalConfigService'][_0x126556(0x20a)]([_0x126556(0x1ff),_0x126556(0x1e7),'cosSecretId',_0x126556(0x1da)]);this[_0x126556(0x1dc)]=new COS({'SecretId':_0x6ff1c6,'SecretKey':_0x49ffee,'FileParallelLimit':0xa});try{const _0x29cd9b=await this[_0x126556(0x20e)](_0x1377d9);return console[_0x126556(0x207)](_0x126556(0x1f2),_0x126556(0x20b)),new Promise((_0x4403b2,_0x4b95e1)=>{const _0x2e0a98=_0x126556;this['cos']['putObject']({'Bucket':_0x3cb412,'Region':_0x38dc65,'Key':dir+'/'+(_0x58c0d3||(0x0,utils_1[_0x2e0a98(0x205)])()+_0x2e0a98(0x1ef)),'StorageClass':_0x2e0a98(0x1e5),'Body':_0x29cd9b},function(_0x3778ac,_0x35f669){const _0x2eaff7=_0x2e0a98;console[_0x2eaff7(0x207)](_0x2eaff7(0x20d));if(_0x3778ac)return console[_0x2eaff7(0x207)]('上传图片出错了:\x20',_0x3778ac),_0x4b95e1(_0x3778ac);return _0x4403b2(_0x35f669['Location'][_0x2eaff7(0x1e8)](/^(http:\/\/|https:\/\/|\/\/|)(.*)/,_0x2eaff7(0x201)));});});}catch(_0x1107ce){console['log'](_0x126556(0x206),_0x1107ce);throw new common_1[(_0x126556(0x209))]('上传图片失败',common_1['HttpStatus'][_0x126556(0x1e3)]);}}async[_0x5da06b(0x20e)](_0x39d80a){const _0x3f9d7b=_0x5da06b,_0x2abc7c=await this['globalConfigService'][_0x3f9d7b(0x20a)](['mjProxy'])||0x0;console['log'](_0x3f9d7b(0x1e1),_0x2abc7c);if(_0x2abc7c==0x1){const _0x5e6122='http://23.224.102.32:3000/mj/pipe?url='+encodeURIComponent(_0x39d80a),_0x3a2834=await axios_1[_0x3f9d7b(0x1f7)][_0x3f9d7b(0x1eb)](_0x5e6122,{'responseType':_0x3f9d7b(0x1f5)});return _0x3a2834[_0x3f9d7b(0x1f4)];}else{const _0x3cbfb6=await axios_1[_0x3f9d7b(0x1f7)][_0x3f9d7b(0x1eb)](_0x39d80a,{'responseType':_0x3f9d7b(0x1f5)});return new Promise((_0x10ecfa,_0xea7252)=>{const _0x4bfccc=_0x3f9d7b;streamToBuffer(_0x3cbfb6[_0x4bfccc(0x1f4)],(_0x2a455a,_0x415252)=>{const _0x576e8e=_0x4bfccc;if(_0x2a455a)throw new common_1[(_0x576e8e(0x209))](_0x576e8e(0x1de),common_1[_0x576e8e(0x1f0)][_0x576e8e(0x1e3)]);else _0x10ecfa(_0x415252);});});}}async[_0x5da06b(0x20c)](){const _0x2c4466=_0x5da06b,_0x2dced2={'filename':_0x2c4466(0x1fe),'dir':'mj','url':'https://cdn.discordapp.com/attachments/1097409128491651135/1105187991938416640/Snine_Always_cartoon_kitten_81513ac0-4bdd-4fb1-a139-7f15971efecd.png'},_0x1d2f3f=await this[_0x2c4466(0x210)](_0x2dced2);console[_0x2c4466(0x207)]('res:\x20',_0x1d2f3f);}};UploadService=__decorate([(0x0,common_1['Injectable'])(),__metadata(_0x5da06b(0x1ee),[globalConfig_service_1[_0x5da06b(0x1fc)]])],UploadService),exports[_0x5da06b(0x1fa)]=UploadService;