'use strict';const _0x50d8da=_0x3857;function _0x2312(){const _0x47f105=['function','response','axios','../userBalance/balance.entity','design:paramtypes','\x20次开始查询[变换图片]','getMjDefaultParams','http://23.224.102.32:3000/mj/list?channel_id=','mjChannelId','INTERNAL_SERVER_ERROR','http://23.224.102.32:3000/mj/draw','getConfigs','update','queueCount','BalanceEntity','ChatLogEntity','使用的次数：','mjApplicationId','当前进入速率检测逻辑的用户id:\x20','decorate','BAD_REQUEST','chatLogService','网络连接失败，请稍后再试！','getClientIp','GlobalConfigService','放大单张图片请求失败...','get','__esModule','object','ChatLogService','变换当前图片失败','pollForUpscaleResult','__param','findCurrentVariationImgResult','stringify','checkRateLimit','error:\x20','uploadFileFromUrl','历史记录中不存在当前图片、请确认您放大的图片是否存在','放大custom_id:\x20','变换图片任务结束\x20队列-1:\x20','removeEmoji','\x20队列+1:\x20','放大图片任务结束\x20队列-1:\x20','prompt','where','https://discord.com/api/v9/channels/','find','7180509yXwCgU','./../globalConfig/globalConfig.service','freeQueueUsers','defineProperty','imagine','https://discord.com/api/v9/interactions','axios\x20get:\x20','7090175RupGfK','../chatLog/chatLog.service','replace','本次绘图耗时:\x20','super','有历史信息之间返回:\x20','mjRateLimit','error','match','findOne','__decorate','@nestjs/common','drawWorking','getOwnPropertyDescriptor','max','由于速率限制、当前普通用户限制为','2822304hcLdbW','Like','orderId','开始请求放大图片\x20队列+1:\x20','当前图片没有绘画信息、无法放大!','开始轮询单张放大图片结果','绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...','DeductionKey','474900OCMjIw','includes','queryMessageList','length','mjId','开始请求用户','deductBalance','mjGuildId','url','balance\x20-\x201','\x20次开始查询','Repository','HttpException','variationId','push','uploadService','2yTDMHV','cosUrl:\x20','default','now','extractContent','3273296bukJVb','mjVersion','开始请求变换图片\x20队列+1:\x20','userId\x20=\x20:userId','当前用户','globalConfigService','sleep','log','21395pcelMz','PAINT_TYPE','./../upload/upload.service','../chatLog/chatLog.entity','变化图片任务异常中断\x20队列-1:\x20','13350eKgSXv','findCurrentEnlargeImgResult','enlarge','map','HttpStatus','upscaleSingleImg','post','查询绘制结果失败...','秒请求一次、请合理使用！','开始时间:\x20','axios:\x20','balanceEntity','chatLogEntity','Not','放大当前图片失败','filter','components','InjectRepository','message','查询期间出现错误：','4XVQDRS','parse','绘画超时，请稍后再试！','20817JeUFwI','拿到了远程地址:\x20','findCurrentPromptResult','execute','开始轮询单张变换图片结果','draw','metadata','/messages?limit=50','floor','rateLimits','mjSessionId','checkFree','typeorm','enlargeWorking','mjAuthorization','createQueryBuilder','拿到了查询结果:\x20','__metadata','发送放大指令成功','mjProxy','结束时间:\x20','绘图指令完成','user','pollForResult','checkAuth','balance','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','变换当前图片超时！','sendDrawInteractions','saveChatLog','sendSmInteractions','绘制图片任务结束\x20队列-1:\x20'];_0x2312=function(){return _0x47f105;};return _0x2312();}(function(_0x3c0726,_0x2c1fbc){const _0x3ca932=_0x3857,_0x17d3f8=_0x3c0726();while(!![]){try{const _0x44779a=-parseInt(_0x3ca932(0xb7))/0x1*(-parseInt(_0x3ca932(0xaa))/0x2)+parseInt(_0x3ca932(0x9a))/0x3+-parseInt(_0x3ca932(0xd0))/0x4*(parseInt(_0x3ca932(0x82))/0x5)+parseInt(_0x3ca932(0x92))/0x6+-parseInt(_0x3ca932(0x7b))/0x7+-parseInt(_0x3ca932(0xaf))/0x8+-parseInt(_0x3ca932(0xd3))/0x9*(-parseInt(_0x3ca932(0xbc))/0xa);if(_0x44779a===_0x2c1fbc)break;else _0x17d3f8['push'](_0x17d3f8['shift']());}catch(_0x1f7f16){_0x17d3f8['push'](_0x17d3f8['shift']());}}}(_0x2312,0xd80d6));var __decorate=this&&this[_0x50d8da(0x8c)]||function(_0x170416,_0x490e62,_0x80f84e,_0x4c7372){const _0x585dfd=_0x50d8da;var _0x37dde9=arguments[_0x585dfd(0x9d)],_0x11d1c6=_0x37dde9<0x3?_0x490e62:_0x4c7372===null?_0x4c7372=Object[_0x585dfd(0x8f)](_0x490e62,_0x80f84e):_0x4c7372,_0x346938;if(typeof Reflect===_0x585dfd(0x67)&&typeof Reflect[_0x585dfd(0x106)]===_0x585dfd(0xf3))_0x11d1c6=Reflect[_0x585dfd(0x106)](_0x170416,_0x490e62,_0x80f84e,_0x4c7372);else{for(var _0x2834c3=_0x170416[_0x585dfd(0x9d)]-0x1;_0x2834c3>=0x0;_0x2834c3--)if(_0x346938=_0x170416[_0x2834c3])_0x11d1c6=(_0x37dde9<0x3?_0x346938(_0x11d1c6):_0x37dde9>0x3?_0x346938(_0x490e62,_0x80f84e,_0x11d1c6):_0x346938(_0x490e62,_0x80f84e))||_0x11d1c6;}return _0x37dde9>0x3&&_0x11d1c6&&Object[_0x585dfd(0x7e)](_0x490e62,_0x80f84e,_0x11d1c6),_0x11d1c6;},__metadata=this&&this[_0x50d8da(0xe4)]||function(_0x460993,_0x144fe5){const _0x362920=_0x50d8da;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x362920(0xf3))return Reflect[_0x362920(0xd9)](_0x460993,_0x144fe5);},__param=this&&this[_0x50d8da(0x6b)]||function(_0x431342,_0x9f0f53){return function(_0x172a6f,_0x138413){_0x9f0f53(_0x172a6f,_0x138413,_0x431342);};};Object[_0x50d8da(0x7e)](exports,_0x50d8da(0x66),{'value':!![]}),exports['MjService']=void 0x0;const globalConfig_service_1=require(_0x50d8da(0x7c)),upload_service_1=require(_0x50d8da(0xb9)),common_1=require(_0x50d8da(0x8d)),axios_1=require(_0x50d8da(0xf5)),chatLog_service_1=require(_0x50d8da(0x83)),balance_constant_1=require('../../common/constants/balance.constant'),utils_1=require('../../common/utils'),chatLog_entity_1=require(_0x50d8da(0xba)),typeorm_1=require(_0x50d8da(0xdf)),typeorm_2=require('@nestjs/typeorm'),balance_entity_1=require(_0x50d8da(0xf6));let MjService=class MjService{constructor(_0x5440c9,_0x5a8cd5,_0x21f07c,_0x2f9040,_0xfe89a0){const _0x33c4b2=_0x50d8da;this['chatLogEntity']=_0x5440c9,this[_0x33c4b2(0xc7)]=_0x5a8cd5,this['uploadService']=_0x21f07c,this[_0x33c4b2(0x108)]=_0x2f9040,this[_0x33c4b2(0xb4)]=_0xfe89a0,this[_0x33c4b2(0xdc)]={},this['drawWorking']=[],this[_0x33c4b2(0xe0)]=[],this[_0x33c4b2(0x100)]=0x0,this[_0x33c4b2(0x7d)]={};}async[_0x50d8da(0xd8)](_0x27b021,_0x1bee61){const _0x5a9e54=_0x50d8da;await this[_0x5a9e54(0xeb)](_0x1bee61);const _0x183eab=this[_0x5a9e54(0x8e)][_0x5a9e54(0x7a)](_0x491234=>_0x491234[_0x5a9e54(0x9b)](_0x27b021[_0x5a9e54(0x77)]));if(_0x183eab)throw new common_1['HttpException']('当前提示词已经在任务队列中了、请勿重复提交。。。',common_1['HttpStatus']['BAD_REQUEST']);if(this[_0x5a9e54(0x100)]>=0x3)throw new common_1[(_0x5a9e54(0xa6))]('当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...',common_1[_0x5a9e54(0xc0)][_0x5a9e54(0x107)]);await this['checkRateLimit'](_0x1bee61),this[_0x5a9e54(0x100)]++,console[_0x5a9e54(0xb6)](_0x5a9e54(0x9f)+_0x1bee61['user']['id']+_0x5a9e54(0x75),this[_0x5a9e54(0x100)]);try{const {prompt:_0x6e3cf5}=_0x27b021,_0x27367b=await this[_0x5a9e54(0xc8)][_0x5a9e54(0x7a)]({'where':{'prompt':(0x0,typeorm_1[_0x5a9e54(0x93)])('%'+_0x6e3cf5+'%')}}),_0x295773=_0x27367b[_0x5a9e54(0xbf)](_0x30e1d4=>_0x30e1d4['message_id']);this['drawWorking'][_0x5a9e54(0xa8)](_0x6e3cf5);let _0x163ad4;const _0x54e680=await this[_0x5a9e54(0xef)](_0x6e3cf5,_0x295773);_0x54e680?(console[_0x5a9e54(0xb6)]('历史中存在当前图片、直接获取！'),_0x163ad4=_0x54e680):_0x163ad4=await this['pollForResult'](_0x6e3cf5,_0x295773);this[_0x5a9e54(0x100)]--,console[_0x5a9e54(0xb6)](_0x5a9e54(0xf2),this['queueCount']);const {id:_0x5ab0b9,content:_0x43faae,channel_id:_0x429a4f,attachments:attachments=[],timestamp:_0x43849c}=_0x163ad4;if(!attachments[_0x5a9e54(0x9d)]||!attachments[0x0][_0x5a9e54(0xa2)])throw new common_1[(_0x5a9e54(0xa6))]('绘画失败',common_1[_0x5a9e54(0xc0)][_0x5a9e54(0x107)]);const {filename:_0x277964,url:_0x1d90d6,width:_0x2cc681,height:_0x51e3da,size:_0x1e80f1}=attachments[0x0];console['log'](_0x5a9e54(0xd4),_0x1d90d6);const _0x1ba1d2=await this[_0x5a9e54(0xa9)][_0x5a9e54(0x70)]({'filename':_0x277964,'url':_0x1d90d6});console[_0x5a9e54(0xb6)]('存入图片完成:\x20',_0x1ba1d2);const _0x1c5939={'curIp':(0x0,utils_1['getClientIp'])(_0x1bee61),'userId':_0x1bee61[_0x5a9e54(0xe9)]['id'],'type':balance_constant_1[_0x5a9e54(0x99)][_0x5a9e54(0xb8)],'prompt':_0x6e3cf5,'answer':_0x1ba1d2,'model':'mj','extend':this['removeEmoji'](JSON['stringify'](_0x163ad4)),'message_id':_0x5ab0b9,'variationId':_0x5ab0b9,'upscaleId':_0x5ab0b9,'group':0x1,'fileInfo':JSON[_0x5a9e54(0x6d)]({'width':_0x2cc681,'height':_0x51e3da,'size':_0x1e80f1,'filename':_0x277964,'cosUrl':_0x1ba1d2})};return await this[_0x5a9e54(0x108)][_0x5a9e54(0xf0)](_0x1c5939),await this[_0x5a9e54(0xa0)](_0x1bee61),this[_0x5a9e54(0x8e)]=this[_0x5a9e54(0x8e)]['filter'](_0x33cefb=>_0x33cefb!==_0x27b021[_0x5a9e54(0x77)]),_0x1ba1d2;}catch(_0x5c312d){this[_0x5a9e54(0x100)]--,console[_0x5a9e54(0xb6)]('绘制图片任务异常中断\x20队列-1:\x20',this[_0x5a9e54(0x100)]),this['drawWorking']=this[_0x5a9e54(0x8e)][_0x5a9e54(0xcb)](_0x20d0e7=>_0x20d0e7!==_0x27b021['prompt']);throw new common_1[(_0x5a9e54(0xa6))](_0x5c312d[_0x5a9e54(0xf4)],common_1[_0x5a9e54(0xc0)][_0x5a9e54(0x107)]);}}async[_0x50d8da(0xc1)](_0x53d701,_0x33b580){const _0x32e3e7=_0x50d8da;if(this[_0x32e3e7(0x100)]>=0x3)throw new common_1[(_0x32e3e7(0xa6))]('当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...',common_1[_0x32e3e7(0xc0)][_0x32e3e7(0x107)]);this[_0x32e3e7(0x100)]++,console[_0x32e3e7(0xb6)]('用户'+_0x33b580[_0x32e3e7(0xe9)]['id']+_0x32e3e7(0x95),this['queueCount']);const {message_id:_0x39ed23,orderId:_0xb0a8f7}=_0x53d701;try{const _0x55d66d=await this['chatLogEntity'][_0x32e3e7(0x8b)]({'where':{'message_id':_0x39ed23}});if(!_0x55d66d)throw new common_1[(_0x32e3e7(0xa6))](_0x32e3e7(0x71),common_1['HttpStatus'][_0x32e3e7(0x107)]);const _0x508154=await this[_0x32e3e7(0xc8)][_0x32e3e7(0x8b)]({'where':{'message_id':_0x39ed23,'action':_0x32e3e7(0xbe),'orderId':_0xb0a8f7}});if(_0x508154)throw new common_1[(_0x32e3e7(0xa6))]('当前图片已经放大过了、请勿重复放大!',common_1[_0x32e3e7(0xc0)][_0x32e3e7(0x107)]);const {prompt:_0xff8d7,extend:_0x261856}=_0x55d66d,_0x3cea20=JSON['parse'](_0x261856),{components:components=[]}=_0x3cea20;if(!components[_0x32e3e7(0x9d)])throw new common_1['HttpException'](_0x32e3e7(0x96),common_1[_0x32e3e7(0xc0)]['BAD_REQUEST']);const _0x187c43=components[0x0][_0x32e3e7(0xcc)][_0xb0a8f7-0x1],{custom_id:_0x4d765f}=_0x187c43;console[_0x32e3e7(0xb6)](_0x32e3e7(0x72),_0x4d765f);const _0x4a4a7d={'message_id':_0x39ed23,'custom_id':_0x4d765f,'prompt':_0xff8d7,'orderId':_0xb0a8f7};await this[_0x32e3e7(0xf1)](_0x4a4a7d),console[_0x32e3e7(0xb6)](_0x32e3e7(0xe5));const _0x87dc0b=await this[_0x32e3e7(0x6a)](_0x4a4a7d);this['queueCount']--,console['log'](_0x32e3e7(0x76),this['queueCount']);const {id:_0x3ab20f,content:_0x5f4b11,channel_id:_0x33c8e7,attachments:attachments=[],timestamp:_0x33c74f}=_0x87dc0b;if(!attachments['length']||!attachments[0x0][_0x32e3e7(0xa2)])throw new common_1[(_0x32e3e7(0xa6))](_0x32e3e7(0xca),common_1['HttpStatus'][_0x32e3e7(0x107)]);const {filename:_0x10515f,url:_0x183390,width:_0x48b4c1,height:_0x16b639,size:_0x4826f4}=attachments[0x0],_0x144310=await this[_0x32e3e7(0xa9)][_0x32e3e7(0x70)]({'filename':_0x10515f,'url':_0x183390});console['log'](_0x32e3e7(0xab),_0x144310);const _0x1d7530={'curIp':(0x0,utils_1[_0x32e3e7(0x10a)])(_0x33b580),'userId':_0x33b580[_0x32e3e7(0xe9)]['id'],'type':balance_constant_1['DeductionKey'][_0x32e3e7(0xb8)],'prompt':_0xff8d7,'answer':_0x144310,'model':'mj','extend':this['removeEmoji'](JSON[_0x32e3e7(0x6d)](_0x87dc0b)),'message_id':_0x39ed23,'upscaleId':_0x3ab20f,'variationId':_0x3ab20f,'action':'enlarge','orderId':_0x4a4a7d[_0x32e3e7(0x94)],'fileInfo':JSON[_0x32e3e7(0x6d)]({'width':_0x48b4c1,'height':_0x16b639,'size':_0x4826f4,'filename':_0x10515f,'cosUrl':_0x144310})};return await this['chatLogService']['saveChatLog'](_0x1d7530),_0x144310;}catch(_0x5260c){console[_0x32e3e7(0xb6)](_0x32e3e7(0x6f),_0x5260c),this['queueCount']--,console[_0x32e3e7(0xb6)]('放大图片任务异常中断\x20队列-1:\x20',this[_0x32e3e7(0x100)]);throw new common_1[(_0x32e3e7(0xa6))](_0x5260c['response'],common_1[_0x32e3e7(0xc0)][_0x32e3e7(0x107)]);}}async['variationSingleImg'](_0x179b63,_0x2506a5){const _0x13e49d=_0x50d8da;if(this[_0x13e49d(0x100)]>=0x3)throw new common_1[(_0x13e49d(0xa6))](_0x13e49d(0xed),common_1['HttpStatus'][_0x13e49d(0x107)]);await this[_0x13e49d(0xeb)](_0x2506a5),await this[_0x13e49d(0x6e)](_0x2506a5),this['queueCount']++,console[_0x13e49d(0xb6)]('用户'+_0x2506a5[_0x13e49d(0xe9)]['id']+_0x13e49d(0xb1),this[_0x13e49d(0x100)]);const {message_id:_0x2c72f2,orderId:_0x43121e}=_0x179b63;try{const _0x49b0bc=await this['chatLogEntity']['findOne']({'where':{'message_id':_0x2c72f2}});if(!_0x49b0bc)throw new common_1[(_0x13e49d(0xa6))]('历史记录中不存在当前图片、请确认您需要变换的图片是否存在',common_1['HttpStatus'][_0x13e49d(0x107)]);const {prompt:_0x154e19,extend:_0x2ee0d4}=_0x49b0bc,_0x55e592=JSON[_0x13e49d(0xd1)](_0x2ee0d4),{components:components=[]}=_0x55e592;if(!components[_0x13e49d(0x9d)])throw new common_1['HttpException']('当前图片没有绘画信息、无法变体!',common_1[_0x13e49d(0xc0)][_0x13e49d(0x107)]);const _0x59f32c=components[0x1][_0x13e49d(0xcc)][_0x43121e-0x1],{custom_id:_0x3752b2}=_0x59f32c,_0x11fd53=await this[_0x13e49d(0xc8)][_0x13e49d(0x7a)]({'where':{'variationId':(0x0,typeorm_1[_0x13e49d(0xc9)])((0x0,typeorm_1['IsNull'])()),'prompt':(0x0,typeorm_1[_0x13e49d(0x93)])('%'+_0x154e19+'%')}}),_0x51303f=_0x11fd53[_0x13e49d(0xbf)](_0x47c701=>_0x47c701[_0x13e49d(0xa7)]),_0x31b78c={'message_id':_0x2c72f2,'custom_id':_0x3752b2,'prompt':_0x154e19,'orderId':_0x43121e};await this[_0x13e49d(0xf1)](_0x31b78c);const _0x2e5392=await this['pollForVariationResult'](_0x31b78c,_0x51303f);this[_0x13e49d(0x100)]--,console[_0x13e49d(0xb6)](_0x13e49d(0x73),this[_0x13e49d(0x100)]);const {id:_0x49df3e,content:_0x458432,channel_id:_0x479b13,attachments:attachments=[],timestamp:_0x250b84}=_0x2e5392;if(!attachments[_0x13e49d(0x9d)]||!attachments[0x0][_0x13e49d(0xa2)])throw new common_1[(_0x13e49d(0xa6))](_0x13e49d(0x69),common_1[_0x13e49d(0xc0)][_0x13e49d(0x107)]);const {filename:_0x351a63,url:_0x2d7846,width:_0x58ce50,height:_0x29c46a,size:_0x2d57ee}=attachments[0x0],_0x59024e=await this[_0x13e49d(0xa9)]['uploadFileFromUrl']({'filename':_0x351a63,'url':_0x2d7846}),_0x21a1bc={'curIp':(0x0,utils_1[_0x13e49d(0x10a)])(_0x2506a5),'userId':_0x2506a5[_0x13e49d(0xe9)]['id'],'type':balance_constant_1[_0x13e49d(0x99)]['PAINT_TYPE'],'prompt':_0x154e19,'answer':_0x59024e,'model':'mj','group':0x1,'extend':this[_0x13e49d(0x74)](JSON[_0x13e49d(0x6d)](_0x2e5392)),'message_id':_0x49df3e,'upscaleId':_0x49df3e,'variationId':_0x49df3e,'action':'enlarge','orderId':_0x31b78c[_0x13e49d(0x94)],'fileInfo':JSON['stringify']({'width':_0x58ce50,'height':_0x29c46a,'size':_0x2d57ee,'filename':_0x351a63,'cosUrl':_0x59024e})};return await this[_0x13e49d(0x108)][_0x13e49d(0xf0)](_0x21a1bc),_0x59024e;}catch(_0xf83893){console[_0x13e49d(0xb6)](_0x13e49d(0x6f),_0xf83893),this[_0x13e49d(0x100)]--,console[_0x13e49d(0xb6)](_0x13e49d(0xbb),this[_0x13e49d(0x100)]);throw new common_1['HttpException'](_0xf83893[_0x13e49d(0xf4)],common_1[_0x13e49d(0xc0)][_0x13e49d(0x107)]);}}async[_0x50d8da(0xf1)](_0x32847e){const _0x52487b=_0x50d8da,{message_id:_0x3e7ae7,custom_id:_0x7ef41}=_0x32847e,{application_id:_0x4ae35f,guild_id:_0x1d6c4c,channel_id:_0x586248,session_id:_0x11254e,version:_0x3c126b,id:_0xf50a0,authorization:_0x19a037,mjProxy:_0x1ad709}=await this['getMjDefaultParams'](),_0x2b3012=_0x1ad709==0x1?'http://23.224.102.32:3000/mj/draw':'https://discord.com/api/v9/interactions',_0x4840ab={'authorization':_0x19a037},_0x1fe04d={'type':0x3,'guild_id':_0x1d6c4c,'channel_id':_0x586248,'message_flags':0x0,'message_id':_0x3e7ae7,'application_id':_0x4ae35f,'session_id':_0x11254e,'data':{'component_type':0x2,'custom_id':_0x7ef41}};try{await axios_1[_0x52487b(0xac)][_0x52487b(0xc2)](_0x2b3012,_0x1fe04d,{'headers':_0x4840ab}),console['log'](_0x52487b(0xe8));}catch(_0x445526){throw new common_1[(_0x52487b(0xa6))](_0x52487b(0x64),common_1[_0x52487b(0xc0)][_0x52487b(0x107)]);}}async['pollForUpscaleResult'](_0x1b126c){const _0x2c0ed4=_0x50d8da,{message_id:_0x2bb2be,custom_id:_0x3c0876,prompt:_0x29d194,orderId:_0x498a2b}=_0x1b126c;console[_0x2c0ed4(0xb6)](_0x2c0ed4(0x97));let _0x2cf946=null,_0x3bb135=0x0;while(!_0x2cf946&&_0x3bb135<0xa){try{console[_0x2c0ed4(0xb6)]('第\x20'+(_0x3bb135+0x1)+'\x20次开始查询');const _0x13493e=Date['now'](),_0x280f15=await this[_0x2c0ed4(0x9c)]();_0x280f15&&_0x280f15[_0x2c0ed4(0x9d)]&&(_0x2cf946=await this[_0x2c0ed4(0xbd)](_0x280f15,_0x1b126c));const _0x1b7077=Date['now']()-_0x13493e,_0x3b1a5f=0xbb8;await this['sleep'](Math[_0x2c0ed4(0x90)](_0x3b1a5f-_0x1b7077,0x0)),_0x3bb135++;}catch(_0x3b3a6a){console[_0x2c0ed4(0x89)]('查询期间出现错误：'+_0x3b3a6a[_0x2c0ed4(0xce)]);}}return _0x2cf946;}async['pollForVariationResult'](_0x328d7f,_0x1a13d8){const _0x4edd8e=_0x50d8da,{message_id:_0x3c6510,custom_id:_0x3e8fec,prompt:_0x3a8a07,orderId:_0x36f459}=_0x328d7f;console[_0x4edd8e(0xb6)](_0x4edd8e(0xd7));let _0x205e61=null,_0x2edf7e=0x0;while(!_0x205e61&&_0x2edf7e<0xa){try{console[_0x4edd8e(0xb6)]('第\x20'+(_0x2edf7e+0x1)+_0x4edd8e(0xf8));const _0x53e851=Date[_0x4edd8e(0xad)](),_0x491e4b=await this[_0x4edd8e(0x9c)]();_0x491e4b&&_0x491e4b[_0x4edd8e(0x9d)]&&(_0x205e61=await this[_0x4edd8e(0x6c)](_0x491e4b,_0x328d7f,_0x1a13d8));const _0x1c5c3d=Date[_0x4edd8e(0xad)]()-_0x53e851,_0x30e9d0=0x1f40;await this['sleep'](Math[_0x4edd8e(0x90)](_0x30e9d0-_0x1c5c3d,0x0)),_0x2edf7e++;}catch(_0x261c32){console[_0x4edd8e(0x89)](_0x4edd8e(0xcf)+_0x261c32[_0x4edd8e(0xce)]);}}if(!_0x205e61)throw new common_1[(_0x4edd8e(0xa6))](_0x4edd8e(0xee),common_1['HttpStatus'][_0x4edd8e(0x107)]);return _0x205e61;}async[_0x50d8da(0xbd)](_0x269d71,_0xf818f8){const {message_id:_0x50511b,custom_id:_0x3e3e0e,prompt:_0x4e7a91,orderId:_0x1a2587}=_0xf818f8,_0x1a9fbb=_0x269d71['find'](_0x41fce2=>{const _0x4820e2=_0x3857,{content:_0x2bafdd}=_0x41fce2;if(!this[_0x4820e2(0xae)](_0x2bafdd))return![];const {prompt:_0x13bdd6,order:_0x204510}=this['extractContent'](_0x2bafdd);return _0x13bdd6[_0x4820e2(0x9b)](_0xf818f8[_0x4820e2(0x77)])&&_0xf818f8[_0x4820e2(0x94)]===_0x204510;});return _0x1a9fbb;}async['findCurrentVariationImgResult'](_0xffce12,_0x226fd6,_0x1a9c3e){const _0x4c4041=_0x50d8da,{message_id:_0x33c8e5,custom_id:_0x58b145,prompt:_0x14039e,orderId:_0x461d60}=_0x226fd6,_0x10bfac=_0xffce12[_0x4c4041(0x7a)](_0x27c5ec=>{const _0x11ae11=_0x4c4041,{content:_0x467270}=_0x27c5ec,_0x1c7f6b=_0x467270[_0x11ae11(0x8a)](/\*\*(.+?)\*\*/),_0x4a8d3f=_0x1c7f6b?_0x1c7f6b[0x1]:'';if(!_0x4a8d3f)return![];return _0x4a8d3f[_0x11ae11(0x9b)](_0x226fd6['prompt'])&&!_0x1a9c3e['includes'](_0x27c5ec['id']);});return _0x10bfac;}async[_0x50d8da(0xef)](_0x504f35,_0x554a2f){const _0x51492b=_0x50d8da,_0x22382b=await this[_0x51492b(0x9c)](),_0x3123a2=await this[_0x51492b(0xd5)](_0x22382b,_0x504f35,_0x554a2f);if(_0x3123a2)return console[_0x51492b(0xb6)](_0x51492b(0x87),_0x3123a2),_0x3123a2;const {application_id:_0x360e1b,guild_id:_0x440070,channel_id:_0x112ab7,session_id:_0x5e037b,version:_0x2a99e0,id:_0x49d431,authorization:_0x67f65e,mjProxy:_0x25b51f}=await this[_0x51492b(0xf9)](),_0x1bcd2d={'type':0x2,'application_id':_0x360e1b,'guild_id':_0x440070,'channel_id':_0x112ab7,'session_id':_0x5e037b,'data':{'version':_0x2a99e0,'id':_0x49d431,'name':_0x51492b(0x7f),'type':0x1,'options':[{'type':0x3,'name':'prompt','value':_0x504f35}],'attachments':[]}};try{const _0x1e3b03=_0x25b51f==0x1?_0x51492b(0xfd):_0x51492b(0x80),_0x12a7a4={'authorization':_0x67f65e},_0x15c668=await axios_1['default'][_0x51492b(0xc2)](_0x1e3b03,_0x1bcd2d,{'headers':_0x12a7a4});return console[_0x51492b(0xb6)]('发送绘画指令结果:\x20',_0x15c668),![];}catch(_0x1d589e){console[_0x51492b(0xb6)](_0x51492b(0xc6),_0x1d589e);throw new common_1[(_0x51492b(0xa6))](_0x51492b(0x98),common_1['HttpStatus'][_0x51492b(0x107)]);}}async[_0x50d8da(0xea)](_0x3d43a5,_0x4ec53e){const _0x31ca66=_0x50d8da;console[_0x31ca66(0xb6)]('开始查询绘画结果轮询');const _0xe4b514=Date[_0x31ca66(0xad)]();try{const _0x37dc93=0xd,_0x3e5112=0x2ee0,_0x5ab623=0x1388,_0x12b0e0=0x3c*0x3e8;let _0xf5d13b=0x0,_0x4d0b78=![],_0x33a7cb=null;while(!_0x33a7cb&&_0xf5d13b<_0x37dc93){console['log']('第\x20'+(_0xf5d13b+0x1)+_0x31ca66(0xa4));Date[_0x31ca66(0xad)]()-_0xe4b514>=_0x12b0e0&&(_0x4d0b78=!![]);await this[_0x31ca66(0xb5)](_0x4d0b78?_0x5ab623:_0x3e5112);const _0x4addee=await this[_0x31ca66(0x9c)]();_0x33a7cb=await this[_0x31ca66(0xd5)](_0x4addee,_0x3d43a5,_0x4ec53e),_0xf5d13b++;}if(!_0x33a7cb)throw new common_1['HttpException'](_0x31ca66(0xd2),common_1[_0x31ca66(0xc0)][_0x31ca66(0x107)]);const _0x5410c6=Date[_0x31ca66(0xad)]();return console['log'](_0x31ca66(0xc5)+_0xe4b514),console[_0x31ca66(0xb6)](_0x31ca66(0xe7)+_0x5410c6),console['log'](_0x31ca66(0x85)+Math[_0x31ca66(0xdb)]((_0x5410c6-_0xe4b514)/0x3e8)+'\x20S'),_0x33a7cb;}catch(_0x58973d){console[_0x31ca66(0x89)](_0x58973d[_0x31ca66(0xce)]);throw new common_1['HttpException'](_0x31ca66(0x109),common_1[_0x31ca66(0xc0)][_0x31ca66(0xfc)]);}}async['findCurrentPromptResult'](_0x4d87a2,_0x730778,_0x3d8826){const _0x50c03e=_0x50d8da;if(!_0x4d87a2||!_0x4d87a2[_0x50c03e(0x9d)])return;const _0x4d317c=_0x4d87a2[_0x50c03e(0x7a)](_0x2c9395=>{const _0x18fa3c=_0x50c03e,{attachments:attachments=[],content:_0xf358e2,edited_timestamp:_0x401d24}=_0x2c9395;return _0xf358e2[_0x18fa3c(0x9b)](_0x730778)&&attachments[_0x18fa3c(0x9d)]>0x0&&!_0x401d24&&!_0x3d8826[_0x18fa3c(0x9b)](_0x2c9395['id']);});return _0x4d317c||null;}async[_0x50d8da(0x9c)](){const _0x40a8c3=_0x50d8da;try{const {application_id:_0x59888d,guild_id:_0x414ee0,channel_id:_0x166222,session_id:_0x59f6aa,version:_0x4ea2b8,id:_0x40e599,authorization:_0x431e76,mjProxy:_0x53b549}=await this[_0x40a8c3(0xf9)](),_0x4c2238=_0x53b549==0x1?_0x40a8c3(0xfa)+_0x166222:_0x40a8c3(0x79)+_0x166222+_0x40a8c3(0xda),_0x5c686f={'authorization':_0x431e76},_0x35b33b=await axios_1[_0x40a8c3(0xac)][_0x40a8c3(0x65)](_0x4c2238,{'headers':_0x5c686f});return console[_0x40a8c3(0xb6)](_0x40a8c3(0xe3),_0x35b33b['data'][_0x40a8c3(0x9d)]),_0x35b33b['data'];}catch(_0x1cb746){console[_0x40a8c3(0xb6)](_0x40a8c3(0x81),_0x1cb746);throw new common_1[(_0x40a8c3(0xa6))](_0x40a8c3(0xc3),common_1[_0x40a8c3(0xc0)]['BAD_REQUEST']);}}async[_0x50d8da(0xb5)](_0x11b9c8){return new Promise(_0x23ed26=>setTimeout(_0x23ed26,_0x11b9c8));}['extractContent'](_0x3c250b){const _0x4d9b1e=_0x50d8da,_0x354d00=_0x3c250b[_0x4d9b1e(0x8a)](/\*\*(.+?)\*\*/),_0x117a52=_0x3c250b[_0x4d9b1e(0x8a)](/- Image #(\d+)/);if(!_0x354d00||!_0x117a52)return null;const _0x3d831f=_0x354d00[0x1],_0x26f322=parseInt(_0x117a52[0x1]);return{'prompt':_0x3d831f,'order':_0x26f322};}async[_0x50d8da(0xf9)](){const _0x47e9c6=_0x50d8da,_0x47182e=await this[_0x47e9c6(0xb4)][_0x47e9c6(0xfe)]([_0x47e9c6(0x9e),_0x47e9c6(0x104),_0x47e9c6(0xa1),'mjChannelId',_0x47e9c6(0xdd),'mjVersion',_0x47e9c6(0xe1),_0x47e9c6(0x88),_0x47e9c6(0xe6)]),_0x41107d={'application_id':_0x47182e[_0x47e9c6(0x104)],'guild_id':_0x47182e[_0x47e9c6(0xa1)],'channel_id':_0x47182e[_0x47e9c6(0xfb)],'session_id':_0x47182e[_0x47e9c6(0xdd)],'version':_0x47182e[_0x47e9c6(0xb0)],'id':_0x47182e[_0x47e9c6(0x9e)],'authorization':_0x47182e[_0x47e9c6(0xe1)],'mjRateLimit':_0x47182e[_0x47e9c6(0x88)],'mjProxy':_0x47182e[_0x47e9c6(0xe6)]||0x0};return _0x41107d;}[_0x50d8da(0x74)](_0x10e062){const _0x966d7c=_0x50d8da,_0x1b55b7=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x10e062[_0x966d7c(0x84)](_0x1b55b7,'');}async['checkAuth'](_0xe95a3d){const _0x29383c=_0x50d8da,_0x1aea26=await this[_0x29383c(0xc7)][_0x29383c(0x8b)]({'where':{'userId':_0xe95a3d[_0x29383c(0xe9)]['id']}}),{id:_0x2b5e94,balance:_0x17c09d}=_0x1aea26;if(!_0x17c09d||(_0x1aea26===null||_0x1aea26===void 0x0?void 0x0:_0x1aea26[_0x29383c(0xec)])<0x1)throw new common_1[(_0x29383c(0xa6))]('您当前暂无MJ绘画余额！！！',common_1[_0x29383c(0xc0)][_0x29383c(0x107)]);}async[_0x50d8da(0xde)](_0x4c3c12){const _0x6f7bea=_0x50d8da,{id:_0x87c9d8,role:_0x46e0a7}=_0x4c3c12[_0x6f7bea(0xe9)];!this[_0x6f7bea(0x7d)][_0x87c9d8]?this[_0x6f7bea(0x7d)][_0x87c9d8]=0x1:this[_0x6f7bea(0x7d)][_0x87c9d8]=this['freeQueueUsers'][_0x87c9d8]+0x1,console['log'](_0x6f7bea(0xb3)+_0x87c9d8+_0x6f7bea(0x103),this[_0x6f7bea(0x7d)][_0x87c9d8]);}async['checkRateLimit'](_0x5c8e9c){const _0x37d26c=_0x50d8da,{id:_0x47ed06,role:_0x197a36}=_0x5c8e9c[_0x37d26c(0xe9)];console[_0x37d26c(0xb6)](_0x37d26c(0x105),_0x47ed06);if(['admin',_0x37d26c(0x86)][_0x37d26c(0x9b)](_0x197a36))return!![];const {mjRateLimit:_0x4f9d7b}=await this[_0x37d26c(0xf9)]();if(this[_0x37d26c(0xdc)][_0x47ed06]){const _0x3730b9=this[_0x37d26c(0xdc)][_0x47ed06];if(_0x3730b9>Date[_0x37d26c(0xad)]()){console['log']('当前用户\x20'+_0x47ed06+'\x20请求过于频繁！');throw new common_1[(_0x37d26c(0xa6))](_0x37d26c(0x91)+_0x4f9d7b+_0x37d26c(0xc4),common_1[_0x37d26c(0xc0)][_0x37d26c(0x107)]);}else this[_0x37d26c(0xdc)][_0x47ed06]=Date[_0x37d26c(0xad)]()+Number(_0x4f9d7b)*0x3e8;}else{const _0x45bab2=Date[_0x37d26c(0xad)]();this['rateLimits'][_0x47ed06]=_0x45bab2+0x3e8*Number(_0x4f9d7b);}}async['deductBalance'](_0x50d1b1){const _0x5b91f7=_0x50d8da;await this[_0x5b91f7(0xc7)][_0x5b91f7(0xe2)]()[_0x5b91f7(0xff)](balance_entity_1[_0x5b91f7(0x101)])['set']({'balance':()=>_0x5b91f7(0xa3)})[_0x5b91f7(0x78)](_0x5b91f7(0xb2),{'userId':_0x50d1b1[_0x5b91f7(0xe9)]['id']})[_0x5b91f7(0xd6)]();}};function _0x3857(_0x2ef93c,_0x4ea4ae){const _0x23126f=_0x2312();return _0x3857=function(_0x3857a1,_0x1de66d){_0x3857a1=_0x3857a1-0x64;let _0x292b09=_0x23126f[_0x3857a1];return _0x292b09;},_0x3857(_0x2ef93c,_0x4ea4ae);}MjService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_2[_0x50d8da(0xcd)])(chatLog_entity_1[_0x50d8da(0x102)])),__param(0x1,(0x0,typeorm_2[_0x50d8da(0xcd)])(balance_entity_1['BalanceEntity'])),__metadata(_0x50d8da(0xf7),[typeorm_1[_0x50d8da(0xa5)],typeorm_1[_0x50d8da(0xa5)],upload_service_1['UploadService'],chatLog_service_1[_0x50d8da(0x68)],globalConfig_service_1[_0x50d8da(0x10b)]])],MjService),exports['MjService']=MjService;