'use strict';function _0x4b68(){const _0x3a7ed9=['提问时间','../../common/utils','find','group','Not','__esModule','querAllDrawLog','columns','提问问题','findOne','BAD_REQUEST','length','ChatLogEntity','forEach','253068uxhfhP','username','你推荐的图片不存在、请检查！','defineProperty','user','209dIvBsj','@nestjs/common','取消推荐','2884010UKhBar','function','map','__decorate','formatDate','message_id','102571iCfJhe','email','attachment;\x20filename=','design:paramtypes','__metadata','Repository','querDrawLog','querAllChatLog','decorate','Like','@nestjs/typeorm','294wljRtw','DESC','655227bYxcMS','findAndCount','chatlog','prompt','Injectable','HttpException','end','PAINT_TYPE','userId','18fPJhNt','userEntity','CHAT_TYPE','setHeader','20zknMXG','424fAXUYU','write','__param','object','../user/user.entity','chat.xlsx','answer','ChatLogService','model','图片成功！','Content-Disposition','chatLogEntity','recDrawImg','../../common/constants/balance.constant','log','27922ShfOCH','xlsx','addWorksheet','exportExcel','DeductionKey','save','assign','Content-Type','HttpStatus','saveChatLog','2553424bCoGbR','InjectRepository','user:\x20','update','Workbook','super','metadata','1365186wQaOtk'];_0x4b68=function(){return _0x3a7ed9;};return _0x4b68();}const _0x4991f8=_0x39f2;(function(_0x39d009,_0x2b962d){const _0x5df701=_0x39f2,_0x26e68f=_0x39d009();while(!![]){try{const _0x17ca48=-parseInt(_0x5df701(0xeb))/0x1+parseInt(_0x5df701(0xb0))/0x2*(parseInt(_0x5df701(0xe9))/0x3)+-parseInt(_0x5df701(0xba))/0x4+parseInt(_0x5df701(0xf8))/0x5*(-parseInt(_0x5df701(0xc1))/0x6)+-parseInt(_0x5df701(0xde))/0x7*(-parseInt(_0x5df701(0xa1))/0x8)+-parseInt(_0x5df701(0xf4))/0x9*(-parseInt(_0x5df701(0xd8))/0xa)+parseInt(_0x5df701(0xd5))/0xb*(parseInt(_0x5df701(0xd0))/0xc);if(_0x17ca48===_0x2b962d)break;else _0x26e68f['push'](_0x26e68f['shift']());}catch(_0xc400b){_0x26e68f['push'](_0x26e68f['shift']());}}}(_0x4b68,0xe042d));function _0x39f2(_0x2c6f40,_0x5a25db){const _0x4b681a=_0x4b68();return _0x39f2=function(_0x39f274,_0x23cb93){_0x39f274=_0x39f274-0xa1;let _0xa7946f=_0x4b681a[_0x39f274];return _0xa7946f;},_0x39f2(_0x2c6f40,_0x5a25db);}var __decorate=this&&this[_0x4991f8(0xdb)]||function(_0x3df4c2,_0xf483d4,_0x4caa83,_0x254bbd){const _0x5017dd=_0x4991f8;var _0x47c980=arguments['length'],_0x5abdbc=_0x47c980<0x3?_0xf483d4:_0x254bbd===null?_0x254bbd=Object['getOwnPropertyDescriptor'](_0xf483d4,_0x4caa83):_0x254bbd,_0x389758;if(typeof Reflect===_0x5017dd(0xa4)&&typeof Reflect[_0x5017dd(0xe6)]==='function')_0x5abdbc=Reflect[_0x5017dd(0xe6)](_0x3df4c2,_0xf483d4,_0x4caa83,_0x254bbd);else{for(var _0x471e47=_0x3df4c2[_0x5017dd(0xcd)]-0x1;_0x471e47>=0x0;_0x471e47--)if(_0x389758=_0x3df4c2[_0x471e47])_0x5abdbc=(_0x47c980<0x3?_0x389758(_0x5abdbc):_0x47c980>0x3?_0x389758(_0xf483d4,_0x4caa83,_0x5abdbc):_0x389758(_0xf483d4,_0x4caa83))||_0x5abdbc;}return _0x47c980>0x3&&_0x5abdbc&&Object[_0x5017dd(0xd3)](_0xf483d4,_0x4caa83,_0x5abdbc),_0x5abdbc;},__metadata=this&&this[_0x4991f8(0xe2)]||function(_0x29930c,_0x112726){const _0x3ccbd9=_0x4991f8;if(typeof Reflect==='object'&&typeof Reflect[_0x3ccbd9(0xc0)]===_0x3ccbd9(0xd9))return Reflect['metadata'](_0x29930c,_0x112726);},__param=this&&this[_0x4991f8(0xa3)]||function(_0x530dd4,_0x42c692){return function(_0x3e23c8,_0xee2ac5){_0x42c692(_0x3e23c8,_0xee2ac5,_0x530dd4);};};Object['defineProperty'](exports,_0x4991f8(0xc7),{'value':!![]}),exports[_0x4991f8(0xa8)]=void 0x0;const common_1=require(_0x4991f8(0xd6)),typeorm_1=require(_0x4991f8(0xe8)),chatLog_entity_1=require('./chatLog.entity'),typeorm_2=require('typeorm'),balance_constant_1=require(_0x4991f8(0xae)),user_entity_1=require(_0x4991f8(0xa5)),utils_1=require(_0x4991f8(0xc3)),ExcelJS=require('exceljs');let ChatLogService=class ChatLogService{constructor(_0x1765d1,_0x7571c9){const _0x1fa8a8=_0x4991f8;this[_0x1fa8a8(0xac)]=_0x1765d1,this[_0x1fa8a8(0xf5)]=_0x7571c9;}async[_0x4991f8(0xb9)](_0x2e9165){const _0x3626b1=_0x4991f8;return await this[_0x3626b1(0xac)][_0x3626b1(0xb5)](_0x2e9165);}async[_0x4991f8(0xe4)](_0x3bd57c,_0x5d3d47){const _0x1024bc=_0x4991f8,{id:_0x2e69c6}=_0x3bd57c[_0x1024bc(0xd4)],{model:_0x2b4888}=_0x5d3d47,_0x3af239={'userId':_0x2e69c6,'type':balance_constant_1[_0x1024bc(0xb4)][_0x1024bc(0xf2)]};return _0x2b4888&&(_0x3af239[_0x1024bc(0xa9)]=_0x2b4888),this['chatLogEntity']['find']({'where':_0x3af239,'order':{'id':'DESC'},'select':['id',_0x1024bc(0xa7),_0x1024bc(0xee),_0x1024bc(0xdd),_0x1024bc(0xc5)]});}async[_0x4991f8(0xc8)](_0x176c56){const _0x5ae784=_0x4991f8,{page:page=0x1,size:size=0x14,rec:_0x5ed62e,userId:_0x37f8f9,model:_0x10eca7}=_0x176c56,_0x537a19={'type':balance_constant_1['DeductionKey'][_0x5ae784(0xf2)],'prompt':(0x0,typeorm_2[_0x5ae784(0xc6)])(''),'answer':(0x0,typeorm_2[_0x5ae784(0xc6)])('')};_0x5ed62e&&Object['assign'](_0x537a19,{'rec':_0x5ed62e}),_0x37f8f9&&Object[_0x5ae784(0xb6)](_0x537a19,{'userId':_0x37f8f9}),_0x10eca7&&Object[_0x5ae784(0xb6)](_0x537a19,{'model':_0x10eca7});const [_0x21e264,_0x6febf7]=await this[_0x5ae784(0xac)][_0x5ae784(0xec)]({'order':{'id':_0x5ae784(0xea)},'skip':(page-0x1)*size,'take':size,'where':_0x537a19});return{'rows':_0x21e264,'count':_0x6febf7};}async[_0x4991f8(0xad)](_0x240c17){const _0x79ab49=_0x4991f8,{id:_0x5562a8}=_0x240c17,_0x23669e=await this[_0x79ab49(0xac)]['findOne']({'where':{'id':_0x5562a8,'type':balance_constant_1['DeductionKey'][_0x79ab49(0xf2)]}});if(!_0x23669e)throw new common_1[(_0x79ab49(0xf0))](_0x79ab49(0xd2),common_1[_0x79ab49(0xb8)][_0x79ab49(0xcc)]);const _0x385332=_0x23669e['rec']===0x1?0x0:0x1,_0x5728ba=await this[_0x79ab49(0xac)][_0x79ab49(0xbd)]({'id':_0x5562a8},{'rec':_0x385332});if(_0x5728ba['affected']>0x0)return(_0x385332?'推荐':_0x79ab49(0xd7))+_0x79ab49(0xaa);throw new common_1['HttpException']('你操作的图片不存在、请检查！',common_1[_0x79ab49(0xb8)]['BAD_REQUEST']);}async[_0x4991f8(0xb3)](_0xc92b23,_0x1e1781){const _0x90367c=_0x4991f8,_0x298a3c={'type':balance_constant_1[_0x90367c(0xb4)]['CHAT_TYPE']},{page:page=0x1,size:size=0x1e,prompt:_0xce8ce1,email:_0x56bc64}=_0xc92b23;_0xce8ce1&&Object[_0x90367c(0xb6)](_0x298a3c,{'prompt':(0x0,typeorm_2[_0x90367c(0xe7)])('%'+_0xce8ce1+'%')});if(_0x56bc64){const _0x3c9722=await this[_0x90367c(0xf5)][_0x90367c(0xcb)]({'where':{'email':_0x56bc64}});console[_0x90367c(0xaf)](_0x90367c(0xbc),_0x3c9722),(_0x3c9722===null||_0x3c9722===void 0x0?void 0x0:_0x3c9722['id'])&&Object[_0x90367c(0xb6)](_0x298a3c,{'userId':_0x3c9722['id']});}const [_0x119ae5,_0x20e03c]=await this[_0x90367c(0xac)][_0x90367c(0xec)]({'order':{'id':_0x90367c(0xea)},'skip':(page-0x1)*size,'take':size,'where':_0x298a3c}),_0x480b66=_0x119ae5[_0x90367c(0xda)](_0x5cd672=>_0x5cd672[_0x90367c(0xf3)]),_0x2683f8=await this[_0x90367c(0xf5)][_0x90367c(0xc4)]({'where':{'id':(0x0,typeorm_2['In'])(_0x480b66)}}),_0x130078=_0x119ae5[_0x90367c(0xda)](_0x36f27f=>{const _0x4f0828=_0x90367c,_0xca7495=_0x2683f8[_0x4f0828(0xc4)](_0x132959=>_0x132959['id']===_0x36f27f[_0x4f0828(0xf3)]);return{'username':_0xca7495?_0xca7495[_0x4f0828(0xd1)]:'','email':_0xca7495?_0xca7495[_0x4f0828(0xdf)]:'','prompt':_0x36f27f[_0x4f0828(0xee)],'answer':_0x36f27f[_0x4f0828(0xa7)],'createdAt':(0x0,utils_1[_0x4f0828(0xdc)])(_0x36f27f['createdAt'])};}),_0x1e4068=new ExcelJS[(_0x90367c(0xbe))](),_0x29a3fd=_0x1e4068[_0x90367c(0xb2)](_0x90367c(0xed));_0x29a3fd[_0x90367c(0xc9)]=[{'header':'用户名','key':_0x90367c(0xd1),'width':0x14},{'header':'用户邮箱','key':_0x90367c(0xdf),'width':0x14},{'header':_0x90367c(0xc2),'key':'createdAt','width':0x14},{'header':_0x90367c(0xca),'key':_0x90367c(0xee),'width':0x50},{'header':'回答答案','key':_0x90367c(0xa7),'width':0x96}],_0x130078[_0x90367c(0xcf)](_0x48d05b=>_0x29a3fd['addRow'](_0x48d05b)),_0x1e1781[_0x90367c(0xf7)](_0x90367c(0xb7),'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'),_0x1e1781['setHeader'](_0x90367c(0xab),_0x90367c(0xe0)+_0x90367c(0xa6)),await _0x1e4068[_0x90367c(0xb1)][_0x90367c(0xa2)](_0x1e1781),_0x1e1781[_0x90367c(0xf1)]();}async[_0x4991f8(0xe5)](_0x156ff8,_0x35c100){const _0x3bb411=_0x4991f8,{page:page=0x1,size:size=0x14,userId:_0x556963,prompt:_0x2b4951}=_0x156ff8,_0x2e292c={'type':balance_constant_1[_0x3bb411(0xb4)][_0x3bb411(0xf6)],'prompt':(0x0,typeorm_2[_0x3bb411(0xc6)])('')};_0x556963&&Object[_0x3bb411(0xb6)](_0x2e292c,{'userId':_0x556963}),_0x2b4951&&Object[_0x3bb411(0xb6)](_0x2e292c,{'prompt':(0x0,typeorm_2['Like'])('%'+_0x2b4951+'%')});const [_0x15d1ea,_0x1ae9a4]=await this[_0x3bb411(0xac)]['findAndCount']({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x2e292c}),_0x12dff6=_0x15d1ea[_0x3bb411(0xda)](_0x30591b=>_0x30591b['userId']),_0x46ddaa=await this[_0x3bb411(0xf5)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x12dff6)},'select':['id',_0x3bb411(0xd1),_0x3bb411(0xdf)]});return _0x15d1ea[_0x3bb411(0xcf)](_0x25a151=>{const _0x17c192=_0x3bb411,{username:_0x24715e,email:_0x2bbbc8}=_0x46ddaa[_0x17c192(0xc4)](_0x22c176=>_0x22c176['id']===_0x25a151['userId'])||{};_0x25a151[_0x17c192(0xd1)]=_0x24715e,_0x25a151[_0x17c192(0xdf)]=_0x2bbbc8;}),_0x35c100[_0x3bb411(0xd4)]['role']!==_0x3bb411(0xbf)&&_0x15d1ea[_0x3bb411(0xcf)](_0x4c540a=>_0x4c540a['email']=(0x0,utils_1['maskEmail'])(_0x4c540a[_0x3bb411(0xdf)])),{'rows':_0x15d1ea,'count':_0x1ae9a4};}};ChatLogService=__decorate([(0x0,common_1[_0x4991f8(0xef)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1[_0x4991f8(0xce)])),__param(0x1,(0x0,typeorm_1[_0x4991f8(0xbb)])(user_entity_1['UserEntity'])),__metadata(_0x4991f8(0xe1),[typeorm_2[_0x4991f8(0xe3)],typeorm_2[_0x4991f8(0xe3)]])],ChatLogService),exports[_0x4991f8(0xa8)]=ChatLogService;