'use strict';const _0x1f6219=_0x2563;(function(_0x517232,_0x2fc3f0){const _0x10f017=_0x2563,_0x394102=_0x517232();while(!![]){try{const _0x38e2bc=-parseInt(_0x10f017(0x169))/0x1*(-parseInt(_0x10f017(0x173))/0x2)+-parseInt(_0x10f017(0x131))/0x3+-parseInt(_0x10f017(0x16f))/0x4*(-parseInt(_0x10f017(0x166))/0x5)+-parseInt(_0x10f017(0x154))/0x6+-parseInt(_0x10f017(0x12d))/0x7+parseInt(_0x10f017(0x15b))/0x8*(parseInt(_0x10f017(0x13d))/0x9)+-parseInt(_0x10f017(0x12a))/0xa;if(_0x38e2bc===_0x2fc3f0)break;else _0x394102['push'](_0x394102['shift']());}catch(_0x27842c){_0x394102['push'](_0x394102['shift']());}}}(_0x5a0e,0x51a9a));function _0x5a0e(){const _0x1fe912=['assign','map','当前卡密不存在、请确认您输入的卡密是否正确！','Repository','./cramiPackage.entity','PACKAGE_GIFT','createCrami','自定义卡密必须至少一项余额不为0️零！','CramiPackageEntity','Injectable','decorate','username','./crami.entity','当前卡密已被使用、请确认您输入的卡密是否正确！','871266KsaXQS','HttpException','更新套餐成功！','删除卡密成功！','Like','user','BAD_REQUEST','131992yUGdRs','../../common/constants/balance.constant','email','queryAllCrami','createPackage','CramiEntity','当前卡密不存在、请确认您要删除的卡密是否存在！','isExpired','InjectRepository','find','defineProperty','90XMTcfz','batchDelCrami','findOne','56kTarxK','CramiService','generateCramiCode','code','metadata','__param','42524wNxLhK','update','套餐名称已存在、请勿重复套餐名！','queryAllPackage','18866HSPXkX','delCrami','当前套餐下存在卡密、请先删除卡密后才可删除套餐！','cramiEntity','cramiPackageEntity','forEach','status','function','length','当前卡密已过期、请联系管理员！','DESC','save','findAndCount','generateCrami','object','../userBalance/userBalance.service','../../common/utils','packageId','useCrami','2645660mKRQHg','name','@nestjs/typeorm','1966944FFuPQc','getOwnPropertyDescriptor','__metadata','当前套餐不存在、请检查你的输入参数！','23484PxjYkX','maskEmail','delete','当前卡密已被使用、已使用的卡密禁止删除！','every','HttpStatus','role','更新套餐失败、请重试！','使用卡密成功','userBalanceService','UserEntity','useId','171XkYmTv','affected','count','addBalanceToUser','saveRecordRechargeLog','../user/user.entity','__esModule','design:paramtypes','typeorm'];_0x5a0e=function(){return _0x1fe912;};return _0x5a0e();}var __decorate=this&&this['__decorate']||function(_0x209a82,_0x547ab6,_0x989aa4,_0x1e1a2d){const _0x20990b=_0x2563;var _0x29b8e8=arguments['length'],_0x153a96=_0x29b8e8<0x3?_0x547ab6:_0x1e1a2d===null?_0x1e1a2d=Object[_0x20990b(0x12e)](_0x547ab6,_0x989aa4):_0x1e1a2d,_0x44fa32;if(typeof Reflect==='object'&&typeof Reflect['decorate']==='function')_0x153a96=Reflect[_0x20990b(0x150)](_0x209a82,_0x547ab6,_0x989aa4,_0x1e1a2d);else{for(var _0x261378=_0x209a82[_0x20990b(0x17b)]-0x1;_0x261378>=0x0;_0x261378--)if(_0x44fa32=_0x209a82[_0x261378])_0x153a96=(_0x29b8e8<0x3?_0x44fa32(_0x153a96):_0x29b8e8>0x3?_0x44fa32(_0x547ab6,_0x989aa4,_0x153a96):_0x44fa32(_0x547ab6,_0x989aa4))||_0x153a96;}return _0x29b8e8>0x3&&_0x153a96&&Object[_0x20990b(0x165)](_0x547ab6,_0x989aa4,_0x153a96),_0x153a96;},__metadata=this&&this[_0x1f6219(0x12f)]||function(_0x21d88e,_0x31a387){const _0x3decfa=_0x1f6219;if(typeof Reflect===_0x3decfa(0x125)&&typeof Reflect[_0x3decfa(0x16d)]===_0x3decfa(0x17a))return Reflect[_0x3decfa(0x16d)](_0x21d88e,_0x31a387);},__param=this&&this[_0x1f6219(0x16e)]||function(_0x4518bd,_0x2c9642){return function(_0x10efda,_0x5f2c82){_0x2c9642(_0x10efda,_0x5f2c82,_0x4518bd);};};function _0x2563(_0x2cc90f,_0x3e2286){const _0x5a0ec1=_0x5a0e();return _0x2563=function(_0x256316,_0x4fbc2c){_0x256316=_0x256316-0x124;let _0x1c18fb=_0x5a0ec1[_0x256316];return _0x1c18fb;},_0x2563(_0x2cc90f,_0x3e2286);}Object['defineProperty'](exports,_0x1f6219(0x143),{'value':!![]}),exports[_0x1f6219(0x16a)]=void 0x0;const common_1=require('@nestjs/common'),crami_entity_1=require(_0x1f6219(0x152)),typeorm_1=require(_0x1f6219(0x12c)),typeorm_2=require(_0x1f6219(0x145)),cramiPackage_entity_1=require(_0x1f6219(0x14a)),utils_1=require(_0x1f6219(0x127)),user_entity_1=require(_0x1f6219(0x142)),userBalance_service_1=require(_0x1f6219(0x126)),balance_constant_1=require(_0x1f6219(0x15c));let CramiService=class CramiService{constructor(_0x417aa1,_0x2c59fc,_0x541e4a,_0x145f4b){this['cramiEntity']=_0x417aa1,this['cramiPackageEntity']=_0x2c59fc,this['userEntity']=_0x541e4a,this['userBalanceService']=_0x145f4b;}async['queryOnePackage'](_0x222a79){const _0x4c9e68=_0x1f6219;return await this[_0x4c9e68(0x177)][_0x4c9e68(0x168)]({'where':{'id':_0x222a79}});}async[_0x1f6219(0x172)](_0x50c9e0){const _0x296d83=_0x1f6219,{page:page=0x1,size:size=0xa,name:_0x5c2f3f,status:_0x195300}=_0x50c9e0,_0x518c34={};_0x5c2f3f&&Object[_0x296d83(0x146)](_0x518c34,{'name':(0x0,typeorm_2[_0x296d83(0x158)])('%'+_0x5c2f3f+'%')}),_0x195300&&Object[_0x296d83(0x146)](_0x518c34,{'status':_0x195300});const [_0x519fcb,_0x58e583]=await this['cramiPackageEntity'][_0x296d83(0x17f)]({'skip':(page-0x1)*size,'take':size,'where':_0x518c34,'order':{'order':'DESC'}});return{'rows':_0x519fcb,'count':_0x58e583};}async[_0x1f6219(0x15f)](_0x40ae17){const _0x3776a7=_0x1f6219,{name:_0x29b1b5}=_0x40ae17,_0xda95ac=await this['cramiPackageEntity'][_0x3776a7(0x168)]({'where':{'name':_0x29b1b5}});if(_0xda95ac)throw new common_1[(_0x3776a7(0x155))](_0x3776a7(0x171),common_1[_0x3776a7(0x136)]['BAD_REQUEST']);return await this[_0x3776a7(0x177)]['save'](_0x40ae17);}async['updatePackage'](_0x1fcb06){const _0x464967=_0x1f6219,{id:_0xc43257,name:_0x121039}=_0x1fcb06,_0x1e2b2a=await this[_0x464967(0x177)][_0x464967(0x168)]({'where':{'id':_0xc43257}});if(!_0x1e2b2a)throw new common_1[(_0x464967(0x155))](_0x464967(0x130),common_1['HttpStatus']['BAD_REQUEST']);const _0x3c223a=await this[_0x464967(0x177)][_0x464967(0x170)]({'id':_0xc43257},_0x1fcb06);if(_0x3c223a['affected']>0x0)return _0x464967(0x156);else throw new common_1[(_0x464967(0x155))](_0x464967(0x138),common_1[_0x464967(0x136)][_0x464967(0x15a)]);}async['delPackage'](_0x1f8fed){const _0x489dc5=_0x1f6219,{id:_0x59b46f}=_0x1f8fed,_0x345f04=await this[_0x489dc5(0x176)][_0x489dc5(0x13f)]({'where':{'packageId':_0x59b46f}});if(_0x345f04)throw new common_1['HttpException'](_0x489dc5(0x175),common_1['HttpStatus'][_0x489dc5(0x15a)]);return await this['cramiPackageEntity']['delete']({'id':_0x59b46f});}async[_0x1f6219(0x14c)](_0x192699){const _0x2cd286=_0x1f6219,{packageId:_0x59571a,count:count=0x1}=_0x192699;if(_0x59571a){const _0xdb54e2=await this[_0x2cd286(0x177)]['findOne']({'where':{'id':_0x59571a}});if(!_0xdb54e2)throw new common_1[(_0x2cd286(0x155))]('当前套餐不存在、请确认您选择的套餐是否存在！',common_1['HttpStatus'][_0x2cd286(0x15a)]);const {days:_0x3de6c1,balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,extraReward:extraReward=0x0,extraBalance:extraBalance=0x0,extraUsesLeft:extraUsesLeft=0x0,extraPaintCount:extraPaintCount=0x0}=_0xdb54e2,_0x97ce62={'packageId':_0x59571a,'days':_0x3de6c1||0x0,'balance':extraBalance?balance+extraBalance:balance,'usesLeft':extraUsesLeft?usesLeft+extraUsesLeft:usesLeft,'paintCount':extraPaintCount?paintCount+extraPaintCount:paintCount};return await this[_0x2cd286(0x124)](_0x97ce62,count);}if(!_0x59571a){const {days:days=0x0,balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0}=_0x192699;if([balance,usesLeft,paintCount][_0x2cd286(0x135)](_0x5536c6=>!_0x5536c6))throw new common_1[(_0x2cd286(0x155))](_0x2cd286(0x14d),common_1['HttpStatus'][_0x2cd286(0x15a)]);const _0x2d4cc4={'days':days,'balance':balance,'usesLeft':usesLeft,'paintCount':paintCount};return await this[_0x2cd286(0x124)](_0x2d4cc4,count);}}async[_0x1f6219(0x124)](_0x4062b4,_0x14b44f){const _0x565572=_0x1f6219,_0x52c274=[];for(let _0x42e261=0x0;_0x42e261<_0x14b44f;_0x42e261++){const _0x25615b=(0x0,utils_1[_0x565572(0x16b)])(),_0x40db97=this['cramiEntity']['create'](Object['assign'](Object[_0x565572(0x146)]({},_0x4062b4),{'code':_0x25615b}));_0x52c274['push'](_0x40db97);}return await this[_0x565572(0x176)][_0x565572(0x17e)](_0x52c274);}async[_0x1f6219(0x129)](_0x53e82e,_0x548d8f){const _0x1bcaa4=_0x1f6219,{id:_0x15fc68}=_0x53e82e[_0x1bcaa4(0x159)],_0x1266d7=await this[_0x1bcaa4(0x176)]['findOne']({'where':{'code':_0x548d8f[_0x1bcaa4(0x16c)]}});if(!_0x1266d7)throw new common_1[(_0x1bcaa4(0x155))](_0x1bcaa4(0x148),common_1[_0x1bcaa4(0x136)][_0x1bcaa4(0x15a)]);const {createdAt:_0x2a68bb,days:_0x2fb211,balance:_0x16c22d,usesLeft:_0x3edb30,paintCount:_0x11c541,status:_0xa41104}=_0x1266d7;if(_0xa41104===0x1)throw new common_1['HttpException'](_0x1bcaa4(0x153),common_1[_0x1bcaa4(0x136)][_0x1bcaa4(0x15a)]);if((0x0,utils_1[_0x1bcaa4(0x162)])(_0x2a68bb,_0x2fb211)&&_0x2fb211!==0x0)throw new common_1[(_0x1bcaa4(0x155))](_0x1bcaa4(0x17c),common_1['HttpStatus']['BAD_REQUEST']);return await this['userBalanceService'][_0x1bcaa4(0x140)](_0x15fc68,{'balance':_0x16c22d,'usesLeft':_0x3edb30,'paintCount':_0x11c541}),await this[_0x1bcaa4(0x13a)][_0x1bcaa4(0x141)]({'userId':_0x15fc68,'rechargeType':balance_constant_1['RechargeType'][_0x1bcaa4(0x14b)],'usesLeft':_0x3edb30,'paintCount':_0x11c541,'balance':_0x16c22d}),await this[_0x1bcaa4(0x176)][_0x1bcaa4(0x170)]({'code':_0x548d8f[_0x1bcaa4(0x16c)]},{'useId':_0x15fc68,'status':0x1}),_0x1bcaa4(0x139);}async[_0x1f6219(0x15e)](_0xe4231a,_0x75e936){const _0x143ce0=_0x1f6219,{page:page=0x1,size:size=0xa,status:_0x23db9c,useId:_0x492ed9}=_0xe4231a,_0x543fef={};_0x23db9c&&Object[_0x143ce0(0x146)](_0x543fef,{'status':_0x23db9c}),_0x492ed9&&Object[_0x143ce0(0x146)](_0x543fef,{'useId':_0x492ed9});const [_0x382348,_0x4ee8d3]=await this[_0x143ce0(0x176)]['findAndCount']({'skip':(page-0x1)*size,'take':size,'order':{'createdAt':_0x143ce0(0x17d)},'where':_0x543fef}),_0x367933=_0x382348['map'](_0x2749a4=>_0x2749a4[_0x143ce0(0x13c)]),_0x3cdbe8=_0x382348[_0x143ce0(0x147)](_0xdb19d7=>_0xdb19d7[_0x143ce0(0x128)]),_0x20c15b=await this['userEntity'][_0x143ce0(0x164)]({'where':{'id':(0x0,typeorm_2['In'])(_0x367933)}}),_0x33e25d=await this[_0x143ce0(0x177)][_0x143ce0(0x164)]({'where':{'id':(0x0,typeorm_2['In'])(_0x3cdbe8)}});return _0x382348[_0x143ce0(0x178)](_0x5a0afe=>{const _0x25cc8e=_0x143ce0;var _0x45bab1,_0x20da50,_0x3d30ee;_0x5a0afe[_0x25cc8e(0x151)]=(_0x45bab1=_0x20c15b[_0x25cc8e(0x164)](_0x35e6c7=>_0x35e6c7['id']===_0x5a0afe[_0x25cc8e(0x13c)]))===null||_0x45bab1===void 0x0?void 0x0:_0x45bab1[_0x25cc8e(0x151)],_0x5a0afe[_0x25cc8e(0x15d)]=(_0x20da50=_0x20c15b['find'](_0x531c36=>_0x531c36['id']===_0x5a0afe[_0x25cc8e(0x13c)]))===null||_0x20da50===void 0x0?void 0x0:_0x20da50['email'],_0x5a0afe['packageName']=(_0x3d30ee=_0x33e25d[_0x25cc8e(0x164)](_0x31267c=>_0x31267c['id']===_0x5a0afe[_0x25cc8e(0x128)]))===null||_0x3d30ee===void 0x0?void 0x0:_0x3d30ee[_0x25cc8e(0x12b)];}),_0x75e936[_0x143ce0(0x159)]['role']!=='super'&&_0x382348['forEach'](_0x2fd322=>_0x2fd322[_0x143ce0(0x15d)]=(0x0,utils_1[_0x143ce0(0x132)])(_0x2fd322[_0x143ce0(0x15d)])),_0x75e936[_0x143ce0(0x159)][_0x143ce0(0x137)]!=='super'&&_0x382348[_0x143ce0(0x178)](_0x1251f5=>_0x1251f5[_0x143ce0(0x16c)]=(0x0,utils_1['maskCrami'])(_0x1251f5[_0x143ce0(0x16c)])),{'rows':_0x382348,'count':_0x4ee8d3};}async[_0x1f6219(0x174)](_0x1afdd7){const _0x1de730=_0x1f6219,_0x5e4e7e=await this['cramiEntity'][_0x1de730(0x168)]({'where':{'id':_0x1afdd7}});if(!_0x5e4e7e)throw new common_1[(_0x1de730(0x155))](_0x1de730(0x161),common_1[_0x1de730(0x136)][_0x1de730(0x15a)]);if(_0x5e4e7e[_0x1de730(0x179)]===0x1)throw new common_1['HttpException'](_0x1de730(0x134),common_1[_0x1de730(0x136)][_0x1de730(0x15a)]);return await this['cramiEntity'][_0x1de730(0x133)]({'id':_0x1afdd7});}async[_0x1f6219(0x167)](_0x593fa0){const _0x5594d2=_0x1f6219,{ids:_0x3adf00}=_0x593fa0,_0x1675e9=await this['cramiEntity'][_0x5594d2(0x133)](_0x3adf00);if(_0x1675e9[_0x5594d2(0x13e)]>0x0)return _0x5594d2(0x157);else throw new common_1[(_0x5594d2(0x155))]('删除卡密失败、请重试！',common_1['HttpStatus'][_0x5594d2(0x15a)]);}};CramiService=__decorate([(0x0,common_1[_0x1f6219(0x14f)])(),__param(0x0,(0x0,typeorm_1[_0x1f6219(0x163)])(crami_entity_1[_0x1f6219(0x160)])),__param(0x1,(0x0,typeorm_1[_0x1f6219(0x163)])(cramiPackage_entity_1[_0x1f6219(0x14e)])),__param(0x2,(0x0,typeorm_1[_0x1f6219(0x163)])(user_entity_1[_0x1f6219(0x13b)])),__metadata(_0x1f6219(0x144),[typeorm_2[_0x1f6219(0x149)],typeorm_2['Repository'],typeorm_2[_0x1f6219(0x149)],userBalance_service_1['UserBalanceService']])],CramiService),exports[_0x1f6219(0x16a)]=CramiService;