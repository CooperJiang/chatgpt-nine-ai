'use strict';function _0x4e8d(_0x239b1a,_0x358eaf){const _0x4cbba2=_0x4cbb();return _0x4e8d=function(_0x4e8d55,_0x34a40d){_0x4e8d55=_0x4e8d55-0x1ac;let _0x50bd0b=_0x4cbba2[_0x4e8d55];return _0x50bd0b;},_0x4e8d(_0x239b1a,_0x358eaf);}function _0x4cbb(){const _0x245694=['修改白名单成功','openaiTopP','validateBalance','chatProcess','CHAT_TYPE','9NEDLjt','有4的权限但是卡池没有配置、降级为3的卡池','defineProperty','Your\x20request\x20was\x20rejected\x20as\x20a\x20result\x20of\x20our\x20safety\x20system','121qZweVG','model','b64_json','set','__param','gptKeysEntity','chatConfig','maskEmail','chatgpt','key','您的问题中含有敏感词汇、我们已对您的账号进行标记、多次违规将触发账号永久封禁、请注意您的言论！','typeorm','gpt-3.5-turbo-0301','__decorate','id\x20=\x20:id','map','@nestjs/common','email','whiteListEntity','ChatgptService','useCount\x20+\x201','autoreplyService','user','DrawService','SOCKS_PROXY_HOST','OpenAiErrorCodeMessage','当前请求已过载、请稍等会儿再试试吧！','decorate','userBalanceService','message','getGptModelList','服务异常、请重新试试吧！！！','InjectRepository','WhiteListEntity','UserService','../chatLog/chatLog.service','uploadService','text','toLowerCase','configService','userId\x20=\x20:userId','GlobalConfigService','key已存在','usage','write','resolve','importDynamic','GptKeysEntity','gpt-3.5','log','DESC','UploadService','prompt','api','findAndCount','addWhiteUser','deductFromBalance','使用了gpt-4模型、给gpt-4的使用次数+1、总次数-1','./../upload/upload.service','gpt-4','role','Please\x20check\x20the\x20back-end\x20console','key不存在','find','default','push','design:paramtypes','gpt-3.5-turbo','userEntity','Bearer\x20','env','getAllKeyList','post','DALL-E2','getKeyDetail','uploadFile','application/octet-stream;\x20charset=utf-8','ChatGPTAPI','sendMessage','status','UserEntity','.png','getGptParams','../globalConfig/config.entity','DeductionKey','当前记录不存在！','../globalConfig/globalConfig.service','execute','globalConfigService','/v1/models','BAD_REQUEST','affected','Content-type','axios','end','getBalance','本次调用的的模型为:\x20','SOCKS_PROXY_PORT','all','HTTPS_PROXY','../userBalance/userBalance.service','openai-draw','keyStatus','954376sEGtHC','super','username','createQueryBuilder','getWhiteListUser','_maxResponseTokens','draw','response','./../user/user.service','completionParams','stringify','addKey','userId','keyPool','Like','application/json','checkUserStatus','绘制图片失败，请稍后试试吧！','6587XNdPrX','../../common/utils','chatLogService','slice','7240BNeulF','PAINT_TYPE','936954RnquUL','API_REVERSE_PROXY','MoreThan','userService','toFixed','ConfigEntity','whiteListUser','updateWhiteUser','HttpException','@nestjs/typeorm','findOne','draw\x20paompt\x20info\x20<===============*******===============>\x20','update','../badwords/badwords.service','10272321RaawGL','/v1','warn','nine-ai-default-key','绘制图片失败，此次绘画被拒绝了！','openai-chat','hideString','https://api.openai.com','未配置有效key、请先前往后台系统配置！','Repository','from','assign','selectKeyWithWeight','../../common/constants/balance.constant','_maxModelTokens','configEntity','32k','./gptkeys.entity','detail','object','getRandomGptKeyDetail','用户已在白名单中！','getConfigs','UserBalanceService','getUserWhiteList','uuid','nestjs-config','15hsaptt','total_available','filter','weight','openaiBaseUrl','length','base64','您的使用GPT4资格次数已用尽、此后请求将会使用GPT3.5模型、当前暂不主动开放GPT4的使用、如有更多需要、请联系管理员','1610836XMHKEO','HttpStatus','checkBadWords','where','forEach','apiKey','saveChatLog','修改白名单失败','includes','_apiBaseUrl','\x20:\x20\x20key为：','Logger','getClientIp','function','738970OVdJYv','count\x20-\x201','data','badwordsService','-----','getModelAndKeyFromUser','1116406OUeSmr','/v1/images/generations'];_0x4cbb=function(){return _0x245694;};return _0x4cbb();}const _0x10d160=_0x4e8d;(function(_0x4855f4,_0x4fddc2){const _0x2d6096=_0x4e8d,_0x2464b8=_0x4855f4();while(!![]){try{const _0x104a71=-parseInt(_0x2d6096(0x1c3))/0x1+-parseInt(_0x2d6096(0x1af))/0x2+parseInt(_0x2d6096(0x1ca))/0x3*(-parseInt(_0x2d6096(0x235))/0x4)+parseInt(_0x2d6096(0x276))/0x5*(parseInt(_0x2d6096(0x24d))/0x6)+parseInt(_0x2d6096(0x247))/0x7*(parseInt(_0x2d6096(0x24b))/0x8)+parseInt(_0x2d6096(0x25b))/0x9+parseInt(_0x2d6096(0x1bd))/0xa*(parseInt(_0x2d6096(0x1ce))/0xb);if(_0x104a71===_0x4fddc2)break;else _0x2464b8['push'](_0x2464b8['shift']());}catch(_0x3f1228){_0x2464b8['push'](_0x2464b8['shift']());}}}(_0x4cbb,0x9b728));var __decorate=this&&this[_0x10d160(0x1db)]||function(_0x11dce7,_0x141197,_0x58f1be,_0x169d9f){const _0x33850c=_0x10d160;var _0x602815=arguments[_0x33850c(0x1ac)],_0x73b1b9=_0x602815<0x3?_0x141197:_0x169d9f===null?_0x169d9f=Object['getOwnPropertyDescriptor'](_0x141197,_0x58f1be):_0x169d9f,_0x3dadc1;if(typeof Reflect===_0x33850c(0x26e)&&typeof Reflect[_0x33850c(0x1e9)]===_0x33850c(0x1bc))_0x73b1b9=Reflect[_0x33850c(0x1e9)](_0x11dce7,_0x141197,_0x58f1be,_0x169d9f);else{for(var _0x3ce47a=_0x11dce7['length']-0x1;_0x3ce47a>=0x0;_0x3ce47a--)if(_0x3dadc1=_0x11dce7[_0x3ce47a])_0x73b1b9=(_0x602815<0x3?_0x3dadc1(_0x73b1b9):_0x602815>0x3?_0x3dadc1(_0x141197,_0x58f1be,_0x73b1b9):_0x3dadc1(_0x141197,_0x58f1be))||_0x73b1b9;}return _0x602815>0x3&&_0x73b1b9&&Object[_0x33850c(0x1cc)](_0x141197,_0x58f1be,_0x73b1b9),_0x73b1b9;},__metadata=this&&this['__metadata']||function(_0x215c7c,_0x2c08bd){const _0x9e0436=_0x10d160;if(typeof Reflect===_0x9e0436(0x26e)&&typeof Reflect['metadata']==='function')return Reflect['metadata'](_0x215c7c,_0x2c08bd);},__param=this&&this[_0x10d160(0x1d2)]||function(_0x2e5d9a,_0x255bcd){return function(_0x12ef8a,_0x2d3159){_0x255bcd(_0x12ef8a,_0x2d3159,_0x2e5d9a);};};Object[_0x10d160(0x1cc)](exports,'__esModule',{'value':!![]}),exports[_0x10d160(0x1e1)]=void 0x0;const upload_service_1=require(_0x10d160(0x208)),user_service_1=require(_0x10d160(0x23d)),nestjs_config_1=require(_0x10d160(0x275)),common_1=require(_0x10d160(0x1de)),errorMessage_constant_1=require('../../common/constants/errorMessage.constant'),utils_1=require(_0x10d160(0x248)),axios_1=require(_0x10d160(0x22b)),userBalance_service_1=require(_0x10d160(0x232)),balance_constant_1=require(_0x10d160(0x268)),chatLog_service_1=require(_0x10d160(0x1f1)),uuid=require(_0x10d160(0x274)),config_entity_1=require(_0x10d160(0x221)),typeorm_1=require(_0x10d160(0x1d9)),typeorm_2=require(_0x10d160(0x256)),badwords_service_1=require(_0x10d160(0x25a)),autoreply_service_1=require('../autoreply/autoreply.service'),gptkeys_entity_1=require(_0x10d160(0x26c)),globalConfig_service_1=require(_0x10d160(0x224)),whiteList_entity_1=require('./whiteList.entity'),user_entity_1=require('../user/user.entity');let ChatgptService=class ChatgptService{constructor(_0x17e2c0,_0x2d09a4,_0x5d7364,_0x47d8a9,_0x54caaa,_0x557787,_0x429f87,_0x193633,_0x110667,_0x27ad39,_0x918f7f,_0x3a2ae8){const _0x5889b1=_0x10d160;this[_0x5889b1(0x212)]=_0x17e2c0,this[_0x5889b1(0x1d3)]=_0x2d09a4,this[_0x5889b1(0x26a)]=_0x5d7364,this[_0x5889b1(0x1e0)]=_0x47d8a9,this[_0x5889b1(0x1f5)]=_0x54caaa,this['userBalanceService']=_0x557787,this[_0x5889b1(0x249)]=_0x429f87,this['userService']=_0x193633,this[_0x5889b1(0x1f2)]=_0x110667,this[_0x5889b1(0x1c0)]=_0x27ad39,this['autoreplyService']=_0x918f7f,this[_0x5889b1(0x226)]=_0x3a2ae8,this[_0x5889b1(0x253)]=[],this['keyPool']={'list3':[],'list4':[]};}async['onModuleInit'](){const _0x1b6077=_0x10d160;await this[_0x1b6077(0x215)](),await this[_0x1b6077(0x273)]();let _0x49750b=await(0x0,utils_1[_0x1b6077(0x1fc)])(_0x1b6077(0x1d6));_0x49750b=(_0x49750b===null||_0x49750b===void 0x0?void 0x0:_0x49750b[_0x1b6077(0x20e)])?_0x49750b[_0x1b6077(0x20e)]:_0x49750b;const {ChatGPTAPI:_0x4b8b9a,ChatGPTError:_0x2ffe4a,ChatGPTUnofficialProxyAPI:_0x4688c3}=_0x49750b,_0x1c7da5=_0x1b6077(0x262);this['api']=new _0x4b8b9a({'apiKey':_0x1b6077(0x25e),'apiBaseUrl':_0x1c7da5+_0x1b6077(0x25c)});}async['getRandomGptKeyDetail'](_0x24b85a){const _0x117b3b=_0x10d160,{list3:_0x2c3cc7,list4:_0x1e9f74}=this[_0x117b3b(0x242)];if(_0x2c3cc7[_0x117b3b(0x1ac)]===0x0&&_0x1e9f74[_0x117b3b(0x1ac)]===0x0)throw new common_1['HttpException'](_0x117b3b(0x263),common_1[_0x117b3b(0x1b0)]['BAD_REQUEST']);if(_0x24b85a===0x3){if(_0x2c3cc7[_0x117b3b(0x1ac)]===0x0)throw new common_1[(_0x117b3b(0x255))]('未配置[卡池3]的有效key、请先前往后台系统配置！',common_1[_0x117b3b(0x1b0)][_0x117b3b(0x228)]);return(0x0,utils_1['selectKeyWithWeight'])(_0x2c3cc7);}if(_0x24b85a===0x4){if(_0x1e9f74[_0x117b3b(0x1ac)]===0x0){console[_0x117b3b(0x1ff)](_0x117b3b(0x1cb));if(_0x2c3cc7[_0x117b3b(0x1ac)]===0x0)throw new common_1[(_0x117b3b(0x255))](_0x117b3b(0x263),common_1[_0x117b3b(0x1b0)][_0x117b3b(0x228)]);else return(0x0,utils_1['selectKeyWithWeight'])(_0x2c3cc7);}else return(0x0,utils_1[_0x117b3b(0x267)])(_0x1e9f74);}}async[_0x10d160(0x220)](_0x296493,_0x32de3b){const _0x48b124=_0x10d160,{parentMessageId:_0x433fb0,temperature:_0x4b6d11,top_p:_0x65e2c6}=_0x32de3b,_0x3b2289=this[_0x48b124(0x226)]['getConfigs']([_0x48b124(0x27a),'openaiTimeoutMs','openaiTemperature',_0x48b124(0x1c6)]),{openaiBaseUrl:_0xa9fc5a,openaiTimeoutMs:openaiTimeoutMs=0x5a*0x3e8*0xa}=_0x3b2289,_0x5a3a39=await this[_0x48b124(0x1c2)](_0x296493),{model:_0x2bf7d7,key:_0xfb5bf0}=_0x5a3a39,_0x1e153a=Object['assign']({'parentMessageId':_0x433fb0,'openaiTimeoutMs':openaiTimeoutMs,'completionParams':{'model':_0x2bf7d7,'temperature':_0x4b6d11}},_0x32de3b);return{'options':_0x1e153a,'key':_0xfb5bf0};}async[_0x10d160(0x1c8)](_0xf065e0,_0x5deba1,_0x11c6b6){const _0x3b7188=_0x10d160;var _0xf4f2c7,_0x3d97c8,_0x12b93e;const {prompt:_0x1e0314,options:_0x3ba0ef,systemMessage:_0x36cd58}=_0xf065e0;let _0x45aa40=!![];try{await this[_0x3b7188(0x250)][_0x3b7188(0x245)](_0x5deba1['user']['id']),await this['userBalanceService'][_0x3b7188(0x1c7)](_0x5deba1['user']['id'],balance_constant_1[_0x3b7188(0x222)][_0x3b7188(0x1c9)],0x1),_0x11c6b6['setHeader'](_0x3b7188(0x22a),_0x3b7188(0x21a));if(await this[_0x3b7188(0x1c0)][_0x3b7188(0x1b1)](_0x1e0314)){const _0x18992a={'message':_0x3b7188(0x1d8),'code':0x1f4};return _0x11c6b6['write'](JSON[_0x3b7188(0x23f)](_0x18992a));}const _0x26f6db=await this[_0x3b7188(0x1e3)]['checkAutoReply'](_0x1e0314);if(_0x26f6db){const _0x402a1={'message':_0x26f6db,'code':0x1f4};return _0x11c6b6['write'](JSON['stringify'](_0x402a1));}const _0x3e642b=await this['globalConfigService'][_0x3b7188(0x271)]([_0x3b7188(0x27a)]);this[_0x3b7188(0x203)][_0x3b7188(0x1b8)]=_0x3e642b+_0x3b7188(0x25c);const _0x21afdb=await this[_0x3b7188(0x220)](_0x5deba1[_0x3b7188(0x1e4)]['id'],_0x3ba0ef),{options:_0x430b98,key:_0x3d525b}=_0x21afdb;this[_0x3b7188(0x203)][_0x3b7188(0x1b4)]=_0x3d525b;const {model:_0x4634ed}=_0x430b98[_0x3b7188(0x23e)];let _0x128ebf=0x1000,_0x4eb673=0x3e8;_0x4634ed[_0x3b7188(0x1f4)]()[_0x3b7188(0x1b7)](_0x3b7188(0x209))&&(_0x4634ed['toLowerCase']()[_0x3b7188(0x1b7)](_0x3b7188(0x26b))?(_0x128ebf=0x8000,_0x4eb673=0x2000):(_0x128ebf=0x2000,_0x4eb673=0x800));this[_0x3b7188(0x203)][_0x3b7188(0x269)]=_0x128ebf,this[_0x3b7188(0x203)][_0x3b7188(0x23a)]=_0x4eb673,common_1['Logger'][_0x3b7188(0x25d)](_0x3b7188(0x22e)+_0x4634ed+'\x20《===》\x20用户id\x20'+_0x5deba1[_0x3b7188(0x1e4)]['id']+_0x3b7188(0x1b9)+_0x3d525b,'ChatgptService');const _0x5c8ced=await this[_0x3b7188(0x203)][_0x3b7188(0x21c)](_0x1e0314,Object[_0x3b7188(0x266)](Object[_0x3b7188(0x266)]({},_0x430b98),{'onProgress':_0x18ba6e=>{const _0x28a1be=_0x3b7188;_0x11c6b6[_0x28a1be(0x1fa)](_0x45aa40?JSON[_0x28a1be(0x23f)](_0x18ba6e):'\x0a'+JSON[_0x28a1be(0x23f)](_0x18ba6e)),_0x45aa40=![];}})),{prompt_tokens:_0x52e014,completion_tokens:_0x2ae1cb,total_tokens:total_tokens=0x0}=(_0xf4f2c7=_0x5c8ced===null||_0x5c8ced===void 0x0?void 0x0:_0x5c8ced['detail'])===null||_0xf4f2c7===void 0x0?void 0x0:_0xf4f2c7[_0x3b7188(0x1f9)];await this[_0x3b7188(0x1ea)][_0x3b7188(0x206)](_0x5deba1['user']['id'],balance_constant_1[_0x3b7188(0x222)]['CHAT_TYPE'],0x1,total_tokens);const _0x47d5b1=(0x0,utils_1[_0x3b7188(0x1bb)])(_0x5deba1);return await this[_0x3b7188(0x249)]['saveChatLog']({'curIp':_0x47d5b1,'userId':_0x5deba1[_0x3b7188(0x1e4)]['id'],'type':balance_constant_1['DeductionKey'][_0x3b7188(0x1c9)],'prompt':_0x1e0314,'answer':_0x5c8ced===null||_0x5c8ced===void 0x0?void 0x0:_0x5c8ced[_0x3b7188(0x1f3)],'promptTokens':_0x52e014,'completionTokens':_0x2ae1cb,'totalTokens':total_tokens,'model':(_0x3d97c8=_0x5c8ced===null||_0x5c8ced===void 0x0?void 0x0:_0x5c8ced['detail'])===null||_0x3d97c8===void 0x0?void 0x0:_0x3d97c8[_0x3b7188(0x1cf)]}),((_0x12b93e=_0x5c8ced===null||_0x5c8ced===void 0x0?void 0x0:_0x5c8ced[_0x3b7188(0x26d)])===null||_0x12b93e===void 0x0?void 0x0:_0x12b93e[_0x3b7188(0x1cf)][_0x3b7188(0x1b7)](_0x3b7188(0x209)))&&(await this[_0x3b7188(0x1e0)]['createQueryBuilder']()[_0x3b7188(0x259)](whiteList_entity_1[_0x3b7188(0x1ef)])[_0x3b7188(0x1d1)]({'useCount':()=>_0x3b7188(0x1e2),'count':()=>_0x3b7188(0x1be)})[_0x3b7188(0x1b2)](_0x3b7188(0x1f6),{'userId':_0x5deba1[_0x3b7188(0x1e4)]['id']})[_0x3b7188(0x225)](),common_1[_0x3b7188(0x1ba)]['warn']('用户'+_0x5deba1[_0x3b7188(0x1e4)]['id']+_0x3b7188(0x207),_0x3b7188(0x1e1))),_0x5c8ced['text']=_0x5c8ced[_0x3b7188(0x1f3)]+='\x20\x20\x0a\x20\x20\x20\x20\x20\x20感谢使用NineAi：正版请添加VX|QQ:\x20927898639',_0x11c6b6[_0x3b7188(0x1fa)]('\x0a'+JSON[_0x3b7188(0x23f)](_0x5c8ced));}catch(_0x2629eb){const _0x268627=_0x2629eb['statusCode'];if(!_0x268627)return _0x11c6b6['write'](JSON[_0x3b7188(0x23f)]({'message':_0x2629eb['message'],'code':0x1f4}));console[_0x3b7188(0x1ff)](_0x3b7188(0x260),_0x2629eb);const _0x5bc8c6=errorMessage_constant_1[_0x3b7188(0x1e7)][_0x268627]?errorMessage_constant_1[_0x3b7188(0x1e7)][_0x268627]:_0x3b7188(0x1ed),_0x357188={'message':_0x5bc8c6||_0x3b7188(0x20b),'code':_0x268627||0x1f4};return _0x11c6b6[_0x3b7188(0x1fa)](JSON['stringify'](_0x357188));}finally{_0x11c6b6[_0x3b7188(0x22c)]();}}async[_0x10d160(0x23b)](_0x25a8d9,_0x4ed263){const _0xc138de=_0x10d160;var _0x117102,_0x574f0f,_0x3770e6,_0x1ae6e6;common_1[_0xc138de(0x1ba)][_0xc138de(0x1ff)](_0xc138de(0x258)+_0x25a8d9[_0xc138de(0x202)],_0xc138de(0x1e5)),await this[_0xc138de(0x250)][_0xc138de(0x245)](_0x4ed263[_0xc138de(0x1e4)]['id']),await this[_0xc138de(0x1ea)][_0xc138de(0x1c7)](_0x4ed263[_0xc138de(0x1e4)]['id'],balance_constant_1[_0xc138de(0x222)]['PAINT_TYPE'],_0x25a8d9['n']||0x1);const _0x1fc78d=await this[_0xc138de(0x226)][_0xc138de(0x271)](['openaiBaseUrl'])||_0xc138de(0x262),_0x2660a1=_0x1fc78d+_0xc138de(0x1c4);let _0x22271c=[];const _0x332571=await this[_0xc138de(0x26f)](0x3),{key:_0x10531b}=_0x332571;try{const _0x47da03=await axios_1['default'][_0xc138de(0x216)](_0x2660a1,Object[_0xc138de(0x266)](Object[_0xc138de(0x266)]({},_0x25a8d9),{'response_format':'b64_json'}),{'headers':{'Authorization':'Bearer\x20'+_0x10531b}});_0x22271c=_0x47da03[_0xc138de(0x1bf)][_0xc138de(0x1bf)];}catch(_0x25310c){console['log'](_0xc138de(0x233),_0x25310c);const _0x361984=((_0x117102=_0x25310c===null||_0x25310c===void 0x0?void 0x0:_0x25310c[_0xc138de(0x23c)])===null||_0x117102===void 0x0?void 0x0:_0x117102[_0xc138de(0x21d)])||0x1f4,_0x17681c=(_0x1ae6e6=(_0x3770e6=(_0x574f0f=_0x25310c===null||_0x25310c===void 0x0?void 0x0:_0x25310c[_0xc138de(0x23c)])===null||_0x574f0f===void 0x0?void 0x0:_0x574f0f[_0xc138de(0x1bf)])===null||_0x3770e6===void 0x0?void 0x0:_0x3770e6['error'])===null||_0x1ae6e6===void 0x0?void 0x0:_0x1ae6e6[_0xc138de(0x1eb)];if(_0x361984===0x1ad)throw new common_1['HttpException'](_0xc138de(0x1e8),common_1[_0xc138de(0x1b0)][_0xc138de(0x228)]);if(_0x361984===0x190||_0x17681c[_0xc138de(0x1b7)](_0xc138de(0x1cd)))throw new common_1[(_0xc138de(0x255))]('您的请求已被系统拒绝。您的提示可能存在一些非法的文本。',common_1[_0xc138de(0x1b0)][_0xc138de(0x228)]);if(_0x361984===0x1f4)throw new common_1[(_0xc138de(0x255))]('绘制图片失败，请检查你的提示词是否有非法描述！',common_1[_0xc138de(0x1b0)][_0xc138de(0x228)]);if(_0x361984===0x191)throw new common_1[(_0xc138de(0x255))](_0xc138de(0x25f),common_1[_0xc138de(0x1b0)][_0xc138de(0x228)]);throw new common_1['HttpException'](_0xc138de(0x246),common_1[_0xc138de(0x1b0)]['BAD_REQUEST']);}const _0xf727c6=[];for(const _0x5cc042 of _0x22271c){const _0x5d1c2d=uuid['v4']()[_0xc138de(0x24a)](0x0,0xa)+_0xc138de(0x21f),_0x511471=Buffer[_0xc138de(0x265)](_0x5cc042[_0xc138de(0x1d0)],_0xc138de(0x1ad));_0xf727c6[_0xc138de(0x20f)](this['uploadService'][_0xc138de(0x219)]({'filename':_0x5d1c2d,'buffer':_0x511471}));}const _0x54ac93=await Promise[_0xc138de(0x230)](_0xf727c6);await this[_0xc138de(0x1ea)][_0xc138de(0x206)](_0x4ed263['user']['id'],balance_constant_1[_0xc138de(0x222)][_0xc138de(0x24c)],_0x25a8d9['n'],_0x25a8d9['n']||0x1);const _0x5631d0=(0x0,utils_1[_0xc138de(0x1bb)])(_0x4ed263),_0x3fe3ba=[];return _0x54ac93['forEach'](_0x40a786=>{const _0x33ae17=_0xc138de;_0x3fe3ba[_0x33ae17(0x20f)](this[_0x33ae17(0x249)][_0x33ae17(0x1b5)]({'curIp':_0x5631d0,'userId':_0x4ed263[_0x33ae17(0x1e4)]['id'],'type':balance_constant_1['DeductionKey'][_0x33ae17(0x24c)],'prompt':_0x25a8d9[_0x33ae17(0x202)],'answer':_0x40a786,'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x33ae17(0x217)}));}),await Promise[_0xc138de(0x230)](_0x3fe3ba),_0x54ac93;}async[_0x10d160(0x22d)](){const _0x4c2c01=_0x10d160;var _0x76f238;const _0x51d18d=_0x4c2c01(0x1c1),_0x33d185=await this[_0x4c2c01(0x226)][_0x4c2c01(0x271)]([_0x4c2c01(0x27a)])||_0x4c2c01(0x262),_0x7dec11=_0x33d185;try{const _0x26a267={'Content-Type':_0x4c2c01(0x244),'Authorization':_0x4c2c01(0x213)+_0x51d18d},_0x1ebdb5=await axios_1['default']['get'](_0x7dec11+'/dashboard/billing/credit_grants',{'headers':_0x26a267}),_0x2c2286=(_0x76f238=_0x1ebdb5['data'][_0x4c2c01(0x277)])!==null&&_0x76f238!==void 0x0?_0x76f238:0x0;return Promise['resolve'](_0x2c2286[_0x4c2c01(0x251)](0x3));}catch(_0x3d9923){return Promise[_0x4c2c01(0x1fb)]('-');}}async[_0x10d160(0x1d4)](){const _0x488895=_0x10d160;var _0x5876f5,_0x284b4c;const _0xa0ffa5=await this[_0x488895(0x22d)](),_0x267c68=(_0x5876f5=process[_0x488895(0x214)][_0x488895(0x24e)])!==null&&_0x5876f5!==void 0x0?_0x5876f5:'-',_0x1726e3=(_0x284b4c=process['env'][_0x488895(0x231)]||process[_0x488895(0x214)]['ALL_PROXY'])!==null&&_0x284b4c!==void 0x0?_0x284b4c:'-',_0x5739ce=process[_0x488895(0x214)][_0x488895(0x1e6)]&&process[_0x488895(0x214)][_0x488895(0x22f)]?process['env']['SOCKS_PROXY_HOST']+':'+process['env'][_0x488895(0x22f)]:'-';return{'apiModel':_0x488895(0x21b),'reverseProxy':_0x267c68,'socksProxy':_0x5739ce,'httpsProxy':_0x1726e3,'balance':_0xa0ffa5};}async['getModelAndKeyFromUser'](_0x134a24){const _0xdeb302=_0x10d160,_0x1e98a9={'model':'','key':''};let _0x53cecb={};const _0xe2f6a6=this['whiteListUser'][_0xdeb302(0x1b7)](_0x134a24);if(!_0xe2f6a6)_0x53cecb=await this[_0xdeb302(0x26f)](0x3);else{const _0x80b16c=await this[_0xdeb302(0x1e0)][_0xdeb302(0x257)]({'where':{'userId':_0x134a24}}),{count:_0x468cad,useCount:_0x132006}=_0x80b16c;if(_0x468cad===0x0){await this[_0xdeb302(0x273)]();throw new common_1['HttpException'](_0xdeb302(0x1ae),common_1[_0xdeb302(0x1b0)][_0xdeb302(0x228)]);}else _0x53cecb=await this[_0xdeb302(0x26f)](0x4);}const {model:_0x4d3a81,key:_0x36e4ff,id:_0x50c25c}=_0x53cecb;return await this[_0xdeb302(0x1d3)][_0xdeb302(0x238)]()[_0xdeb302(0x259)](gptkeys_entity_1[_0xdeb302(0x1fd)])['set']({'useCount':()=>_0xdeb302(0x1e2)})['where'](_0xdeb302(0x1dc),{'id':_0x50c25c})[_0xdeb302(0x225)](),{'model':_0x4d3a81,'key':_0x36e4ff};}async[_0x10d160(0x1ec)](_0x401562){const _0x4585ba=_0x10d160,_0x18a112=await this['globalConfigService'][_0x4585ba(0x271)]([_0x4585ba(0x27a)])||'https://api.openai.com',_0x204605=_0x18a112+_0x4585ba(0x227);try{const _0x53b06e=await axios_1[_0x4585ba(0x20e)]['get'](_0x204605,{'headers':{'Authorization':_0x4585ba(0x213)+_0x401562}}),_0x2adbe2=_0x53b06e['data'][_0x4585ba(0x1bf)][_0x4585ba(0x1dd)](_0x3ec2bd=>_0x3ec2bd['id']),_0x249aa3=[_0x4585ba(0x209),'gpt-4-0314',_0x4585ba(0x1fe),_0x4585ba(0x211),_0x4585ba(0x1da),'ada','davinci'],_0x10e65b=_0x249aa3[_0x4585ba(0x278)](_0x5afeed=>_0x2adbe2[_0x4585ba(0x1b7)](_0x5afeed));return _0x10e65b;}catch(_0x26e271){throw new common_1[(_0x4585ba(0x255))]('获取模型列表失败，请检查你的key是否正确！',common_1[_0x4585ba(0x1b0)][_0x4585ba(0x228)]);}}async['getKeyList'](_0x4e7a83,_0x82694d){const _0x282654=_0x10d160,_0x5ae2dd={},{page:page=0x1,size:size=0xa,key:_0x470cdf,status:_0x5e3df0,keyStatus:_0x2b0f8d,model:_0xa67561}=_0x4e7a83;_0x470cdf&&(_0x5ae2dd['key']=(0x0,typeorm_1[_0x282654(0x243)])('%'+_0x470cdf+'%')),_0x2b0f8d&&(_0x5ae2dd[_0x282654(0x234)]=_0x2b0f8d),_0xa67561&&(_0x5ae2dd['model']=_0xa67561),[0x0,0x1,'0','1'][_0x282654(0x1b7)](_0x5e3df0)&&(_0x5ae2dd[_0x282654(0x21d)]=_0x5e3df0);const [_0x354b89,_0x295656]=await this[_0x282654(0x1d3)]['findAndCount']({'skip':(page-0x1)*size,'take':size,'where':_0x5ae2dd,'order':{'id':_0x282654(0x200)}});return _0x82694d['user'][_0x282654(0x20a)]!==_0x282654(0x236)&&_0x354b89[_0x282654(0x1b3)](_0x26ca70=>_0x26ca70[_0x282654(0x1d7)]=(0x0,utils_1[_0x282654(0x261)])(_0x26ca70[_0x282654(0x1d7)])),{'rows':_0x354b89,'count':_0x295656};}async[_0x10d160(0x218)](_0x3d9d41){return 0x1;}async[_0x10d160(0x240)](_0x15db69){const _0x4c935b=_0x10d160,{key:_0x76a153}=_0x15db69,_0x1497ad=await this[_0x4c935b(0x1d3)]['findOne']({'where':{'key':_0x76a153}});if(_0x1497ad)throw new common_1[(_0x4c935b(0x255))](_0x4c935b(0x1f8),common_1[_0x4c935b(0x1b0)][_0x4c935b(0x228)]);const _0x50f3a2=await this[_0x4c935b(0x1d3)]['save'](_0x15db69);return await this[_0x4c935b(0x215)](),_0x50f3a2;}async['updateKey'](_0x3135c5){const _0x5f260f=_0x10d160,{id:_0x1d15c5}=_0x3135c5,_0x2de52b=await this[_0x5f260f(0x1d3)][_0x5f260f(0x257)]({'where':{'id':_0x1d15c5}});if(!_0x2de52b)throw new common_1['HttpException'](_0x5f260f(0x20c),common_1[_0x5f260f(0x1b0)][_0x5f260f(0x228)]);const _0x3a2d5b=await this['gptKeysEntity'][_0x5f260f(0x259)]({'id':_0x1d15c5},_0x3135c5);if(_0x3a2d5b[_0x5f260f(0x229)]>0x0)return await this[_0x5f260f(0x215)](),'修改成功';else throw new common_1[(_0x5f260f(0x255))]('修改失败',common_1[_0x5f260f(0x1b0)][_0x5f260f(0x228)]);}async[_0x10d160(0x215)](){const _0x575aa6=_0x10d160,_0x16ab2b=await this[_0x575aa6(0x1d3)]['find']({'where':{'status':0x1,'keyStatus':0x1},'select':['id',_0x575aa6(0x1d7),_0x575aa6(0x279),_0x575aa6(0x1cf)]}),_0x21630c=_0x16ab2b[_0x575aa6(0x278)](_0x97cace=>_0x97cace[_0x575aa6(0x1cf)][_0x575aa6(0x1b7)]('gpt-3')),_0x37441f=_0x16ab2b['filter'](_0x386cd5=>_0x386cd5['model']['includes'](_0x575aa6(0x209)));this[_0x575aa6(0x242)]={'list3':_0x21630c,'list4':_0x37441f};}async[_0x10d160(0x273)](){const _0x2b40a0=_0x10d160,_0x519bea=await this[_0x2b40a0(0x1e0)][_0x2b40a0(0x20d)]({'where':{'status':0x1,'count':(0x0,typeorm_1[_0x2b40a0(0x24f)])(0x0)},'select':['userId']});this[_0x2b40a0(0x253)]=_0x519bea['map'](_0x1f4472=>_0x1f4472[_0x2b40a0(0x241)]);}async[_0x10d160(0x205)](_0x3fc083){const _0x5102c5=_0x10d160,{userId:_0x22b089,count:_0x1141d8}=_0x3fc083,_0x328825=await this['whiteListEntity'][_0x5102c5(0x257)]({'where':{'userId':_0x22b089}});if(_0x328825)throw new common_1[(_0x5102c5(0x255))](_0x5102c5(0x270),common_1[_0x5102c5(0x1b0)]['BAD_REQUEST']);const _0x72e8c6=await this[_0x5102c5(0x1e0)]['save'](_0x3fc083);return await this['getUserWhiteList'](),_0x72e8c6;}async[_0x10d160(0x254)](_0x95e9c9){const _0x46eacf=_0x10d160,{id:_0x5898e5}=_0x95e9c9,_0x5b10e1=await this[_0x46eacf(0x1e0)]['findOne']({'where':{'id':_0x5898e5}});if(!_0x5b10e1)throw new common_1[(_0x46eacf(0x255))](_0x46eacf(0x223),common_1['HttpStatus'][_0x46eacf(0x228)]);const _0x3bb209=await this[_0x46eacf(0x1e0)][_0x46eacf(0x259)]({'id':_0x5898e5},_0x95e9c9);if(_0x3bb209[_0x46eacf(0x229)]>0x0)return await this[_0x46eacf(0x273)](),_0x46eacf(0x1c5);else throw new common_1[(_0x46eacf(0x255))](_0x46eacf(0x1b6),common_1[_0x46eacf(0x1b0)][_0x46eacf(0x228)]);}async[_0x10d160(0x239)](_0x4f2351,_0x25b674){const _0x1489cb=_0x10d160,{page:page=0x1,size:size=0xa}=_0x4f2351,[_0x5d1d34,_0x30e2d9]=await this[_0x1489cb(0x1e0)][_0x1489cb(0x204)]({'skip':(page-0x1)*size,'take':size,'order':{'id':_0x1489cb(0x200)}}),_0x57fd54=_0x5d1d34['map'](_0x444ac1=>_0x444ac1[_0x1489cb(0x241)]),_0x3e71ea=await this[_0x1489cb(0x212)][_0x1489cb(0x20d)]({'where':{'id':(0x0,typeorm_1['In'])(_0x57fd54)}});return _0x5d1d34[_0x1489cb(0x1b3)](_0x5b4580=>{const _0x558e55=_0x1489cb;var _0x4da105,_0x4463ee;const _0x54aa96=_0x3e71ea[_0x558e55(0x20d)](_0x4cbaf8=>_0x4cbaf8['id']===_0x5b4580[_0x558e55(0x241)]);_0x5b4580[_0x558e55(0x237)]=(_0x4da105=_0x54aa96===null||_0x54aa96===void 0x0?void 0x0:_0x54aa96['username'])!==null&&_0x4da105!==void 0x0?_0x4da105:'',_0x5b4580[_0x558e55(0x1df)]=(_0x4463ee=_0x54aa96===null||_0x54aa96===void 0x0?void 0x0:_0x54aa96[_0x558e55(0x1df)])!==null&&_0x4463ee!==void 0x0?_0x4463ee:'';}),_0x25b674[_0x1489cb(0x1e4)][_0x1489cb(0x20a)]!=='super'&&_0x5d1d34['forEach'](_0x4d7ef5=>_0x4d7ef5[_0x1489cb(0x1df)]=(0x0,utils_1[_0x1489cb(0x1d5)])(_0x4d7ef5[_0x1489cb(0x1df)])),{'rows':_0x5d1d34,'count':_0x30e2d9};}};ChatgptService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_2[_0x10d160(0x1ee)])(user_entity_1[_0x10d160(0x21e)])),__param(0x1,(0x0,typeorm_2[_0x10d160(0x1ee)])(gptkeys_entity_1[_0x10d160(0x1fd)])),__param(0x2,(0x0,typeorm_2['InjectRepository'])(config_entity_1[_0x10d160(0x252)])),__param(0x3,(0x0,typeorm_2[_0x10d160(0x1ee)])(whiteList_entity_1[_0x10d160(0x1ef)])),__metadata(_0x10d160(0x210),[typeorm_1[_0x10d160(0x264)],typeorm_1[_0x10d160(0x264)],typeorm_1[_0x10d160(0x264)],typeorm_1['Repository'],nestjs_config_1['ConfigService'],userBalance_service_1[_0x10d160(0x272)],chatLog_service_1['ChatLogService'],user_service_1[_0x10d160(0x1f0)],upload_service_1[_0x10d160(0x201)],badwords_service_1['BadwordsService'],autoreply_service_1['AutoreplyService'],globalConfig_service_1[_0x10d160(0x1f7)]])],ChatgptService),exports[_0x10d160(0x1e1)]=ChatgptService;